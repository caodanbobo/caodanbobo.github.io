<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/30/rust-0501-solana&anchor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/30/rust-0501-solana&anchor/" itemprop="url">Rust lesson 5.1 - Solana Dev with Anchor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-11-30T20:12:30+08:00">
                2024-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Solana-Basics"><a href="#Solana-Basics" class="headerlink" title="Solana Basics"></a>Solana Basics</h1><h2 id="1-Account-Model"><a href="#1-Account-Model" class="headerlink" title="1. Account Model"></a>1. Account Model</h2><p><a target="_blank" rel="noopener" href="https://solana.com/docs/core/accounts">Solana Account Model</a></p>
<h2 id="2-Program-Accounts"><a href="#2-Program-Accounts" class="headerlink" title="2. Program Accounts"></a>2. Program Accounts</h2><h3 id="The-Code"><a href="#The-Code" class="headerlink" title="The Code"></a>The Code</h3><p>Here is a simple solnana program coded in anchor:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line">declare_id!(<span class="string">&quot;77xw1CSDzm1G6b554gf5GwbC2P2B4qLH6jPqzBSMZCcx&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[program]</span></span><br><span class="line"><span class="keyword">mod</span> hello_anchor &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">initialize</span>(ctx: Context&lt;Initialize&gt;, data: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        ctx.accounts.new_account.data = data;</span><br><span class="line">        msg!(<span class="string">&quot;Changed data to: &#123;&#125;!&quot;</span>, data);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Initialize</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(init, payer = signer, space = 8 + 8)]</span></span><br><span class="line">    <span class="keyword">pub</span> new_account: Account&lt;<span class="symbol">&#x27;info</span>, NewAccount&gt;,</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> signer: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NewAccount</span> &#123;</span><br><span class="line">    data: <span class="type">u64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This piece of code contains 4 parts:</p>
<ol>
<li>The <code>declare_id!</code> macro specifies the on-chain address of your program.</li>
<li>The <code>#[program]</code> macro annotates a module containing functions that represent the program’s instructions. In other words, this is the logic of the program.</li>
<li>The <code>#[derive(Accounts)]</code> macro is used to define a struct that specifies the accounts required for a particular instruction, where each field represents a separate account. In the example, to invoke <code>fn initialize</code>, we need to prepare all acconts defined in struct <code>Initialize</code></li>
<li>The <code>#[account]</code> macro is used to define a struct that represents the data structure of an account created and owned by the program.</li>
</ol>
<p>In brife:</p>
<ol>
<li>The <code>#[account]</code> defines the data struct used in the solana program account(smart contract).</li>
<li>We can use functions in mod annotated with <code>#[program]</code> to munipulte the data.</li>
<li>However, to invoke certain function, we need to get ready all the accounts it need as <code>#[derive(Accounts)</code> required.</li>
</ol>
<h3 id="Deploying-Programs-on-chain"><a href="#Deploying-Programs-on-chain" class="headerlink" title="Deploying Programs on-chain"></a>Deploying Programs on-chain</h3><p><a target="_blank" rel="noopener" href="https://explorer.solana.com/tx/vmJMGRb2fxePtZpPvnE1JEEYxd4BR2uc1vMiDzkdEsYL3CT4QXgLMFMT6QEjXFR482ontMDBReEquBf376qtBzR?cluster=devnet">Here is the transation of deploying the program.</a></p>
<p>We can see there several accounts in Account input(s) sections, let us see what are those:</p>
<ol>
<li><p><code>DK1RcxQV5pcWetBxpkp3C82B2oALMnFWzsZKPASHMYC5</code></p>
<p>This is my public key, it’s marked as <code>payer, signer, writable</code>:</p>
<ul>
<li>payer, paying for transaction fee and program account rent fee</li>
<li>Signs the transaction to authorize it</li>
<li>writable because Solana deducts funds from this account</li>
</ul>
</li>
<li><p><code>FMN5VwtrXqjMem3NX5Di6WVgFgi8d63jyBJ5BMSZfoZ6</code></p>
<p>This is the account of the program we just deployed.</p>
</li>
<li><p><code>HzvKq6MNEQgMEbVkVZE46sLagAasLe3Ah2GFMZGUVw7M</code></p>
<p>Program’s Program Executable Data Account, storing program’s codes.</p>
</li>
<li><p><code>n8bf7TJfB6NUZYwbruXP2MbQ49Fxw3ARKKjDZMLep71</code></p>
<p>Buffer account used during the deployment, so it is no longer existed.</p>
</li>
<li><p><code>BPFLoaderUpgradeab1e11111111111111111111111</code><br>A special system program that facilitates deploying and upgrading BPF programs on Solana.</p>
</li>
<li><p>sysvar: clock and sysvar: rent.</p>
</li>
</ol>
<p>Exactly what we learnt in <a target="_blank" rel="noopener" href="https://solana.com/docs/core/accounts">Solana Account Model</a>:</p>
<blockquote>
<p>When new programs are deployed on Solana, technically three separate accounts are created:</p>
<ul>
<li><strong>Program Account</strong>:The main account representing an on-chain program. This account stores the address of an executable data account (which stores the compiled program code) and the update authority for the program (address authorized to make changes to the program).</li>
<li><strong>Program Executable Data Account</strong>: An account that contains the executable byte code of the program.</li>
<li><strong>Buffer Account</strong>: A temporary account that stores byte code while a program is being actively deployed or upgraded. Once the process is complete, the data is transferred to the Program Executable Data Account and the buffer account is closed._</li>
</ul>
</blockquote>
<p><img src="https://solana-developer-content.vercel.app/assets/docs/core/accounts/program-account-expanded.svg" alt="alt text"></p>
<h2 id="3-Interacting-with-On-chain-Programs"><a href="#3-Interacting-with-On-chain-Programs" class="headerlink" title="3. Interacting with On-chain Programs"></a>3. Interacting with On-chain Programs</h2><p>let’s use the test script to show you how to interact with the program:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// No imports needed: web3, anchor, pg and more are globally available</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;Test&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;initialize&quot;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Generate keypair for the new account</span></span><br><span class="line">    <span class="keyword">const</span> newAccountKp = <span class="keyword">new</span> web3.<span class="title class_">Keypair</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send transaction</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="keyword">const</span> txHash = <span class="keyword">await</span> pg.<span class="property">program</span>.<span class="property">methods</span></span><br><span class="line">      .<span class="title function_">initialize</span>(data)</span><br><span class="line">      .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">        <span class="attr">newAccount</span>: newAccountKp.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">signer</span>: pg.<span class="property">wallet</span>.<span class="property">publicKey</span>,</span><br><span class="line">        <span class="attr">systemProgram</span>: web3.<span class="property">SystemProgram</span>.<span class="property">programId</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">signers</span>([newAccountKp])</span><br><span class="line">      .<span class="title function_">rpc</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Use &#x27;solana confirm -v <span class="subst">$&#123;txHash&#125;</span>&#x27; to see the logs`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Confirm transaction</span></span><br><span class="line">    <span class="keyword">await</span> pg.<span class="property">connection</span>.<span class="title function_">confirmTransaction</span>(txHash);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch the created account</span></span><br><span class="line">    <span class="keyword">const</span> newAccount = <span class="keyword">await</span> pg.<span class="property">program</span>.<span class="property">account</span>.<span class="property">newAccount</span>.<span class="title function_">fetch</span>(</span><br><span class="line">      newAccountKp.<span class="property">publicKey</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;On-chain data is:&quot;</span>, newAccount.<span class="property">data</span>.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check whether the data on-chain is equal to local &#x27;data&#x27;</span></span><br><span class="line">    <span class="title function_">assert</span>(data.<span class="title function_">eq</span>(newAccount.<span class="property">data</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://explorer.solana.com/tx/2B9j6Vg8nJPk3dMReKZpfQxjcAyDTT1icCMjdxsdCJxgc8VN2ANV1hkBqMdgP66x5uyTK3AHckTioxy6jT745UF5?cluster=devnet">here is the transction of it</a></p>
<p>There are also some accounts list there:</p>
<ol>
<li><p><code>DK1RcxQV5pcWetBxpkp3C82B2oALMnFWzsZKPASHMYC5</code></p>
<p>Same as above, this is my wallet account</p>
</li>
<li><p><code>5CykY57hsTJY3C7gPZrtyPk7s4hbdpmLYyrEmNKvKg5</code></p>
<p>This is the address of data struct ‘NewAccount’</p>
</li>
<li><p>System Program<br>The Solana System Program for:</p>
<ul>
<li>Allocating space for the new account (16 bytes).</li>
<li>Transferring the rent-exempt balance to make the account persistent</li>
<li>Assigning ownership of the new account to the deployed program.</li>
</ul>
</li>
<li><p><code>77xw1CSDzm1G6b554gf5GwbC2P2B4qLH6jPqzBSMZCcx</code></p>
<p>The program account we are interacting.</p>
</li>
</ol>
<h3 id="Data-Account"><a href="#Data-Account" class="headerlink" title="Data Account"></a>Data Account</h3><p>What we did here is calling the <code>initialize</code> function initializing the <code>NewAccount</code>. If we lookup it in the explorer, we can find that:</p>
<ul>
<li>Balance: 0.00100224 Sol</li>
<li>Allocated Data Size: 16 byte(s)</li>
<li>Assigned Program Id: <code>77xw1CSDzm1G6b554gf5GwbC2P2B4qLH6jPqzBSMZCcx</code>(The program id)</li>
<li>Executable: No</li>
</ul>
<p>Comparing to Solidity, the Solana programs are “stateless”, the data is NOT part of the program.</p>
<p><img src="https://solana-developer-content.vercel.app/assets/docs/core/accounts/data-account.svg" alt="alt text"></p>
<p>If we look closely, we can find that the keypair of the data account is created or provided by the user, however the data account on-chain is owned by the program, how to understand this?</p>
<ol>
<li>Account Creation and Funding. The program itslef can not generate accounts, and creating account requires funds</li>
<li>Ownership is Transferred. When the account is initialized on-chain, the program becomes the “owner” of the account:<ul>
<li>The account’s behavior is governed by the program’s logic.</li>
<li>Only instructions defined in the program can modify the account’s data.</li>
</ul>
</li>
</ol>
<p>Although the keypair is controled by the user, once the data account is on-chain, the keypair is useless, user can ONLY interact with it via the program. For example, we want to restrict the update operation to the creator account:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//snip</span></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Update</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut, has_one = owner)]</span></span><br><span class="line">    <span class="keyword">pub</span> new_account: Account&lt;<span class="symbol">&#x27;info</span>, NewAccount&gt;,</span><br><span class="line">    <span class="keyword">pub</span> owner: Signer&lt;<span class="symbol">&#x27;info</span>&gt;, <span class="comment">// Only the owner can authorize changes</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//snip</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NewAccount</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> owner: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> data: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Program-Derived-Accounts"><a href="#4-Program-Derived-Accounts" class="headerlink" title="4. Program Derived Accounts"></a>4. Program Derived Accounts</h2><p>PDA is a bit different comparing to the data account we learnt in previous section, it is generated fully by the program.You can think of PDAs as a way to create hashmap-like structures on-chain from a predefined set of inputs.<br><img src="https://solana-developer-content.vercel.app/assets/docs/core/pda/pda-derivation.svg" alt="alt text"></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line">declare_id!(<span class="string">&quot;75GJVCJNhaukaa2vCCqhreY31gaphv7XTScBChmr1ueR&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[program]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> pda_account &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">initialize</span>(ctx: Context&lt;Initialize&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">account_data</span> = &amp;<span class="keyword">mut</span> ctx.accounts.pda_account;</span><br><span class="line">        <span class="comment">// store the address of the `user`</span></span><br><span class="line">        account_data.user = *ctx.accounts.user.key;</span><br><span class="line">        <span class="comment">// store the canonical bump</span></span><br><span class="line">        account_data.bump = ctx.bumps.pda_account;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Initialize</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> user: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        // set the seeds to derive the PDA</span></span><br><span class="line"><span class="meta">        seeds = [b<span class="string">&quot;data&quot;</span>, user.key().as_ref()]</span>,</span><br><span class="line">        <span class="comment">// use the canonical bump</span></span><br><span class="line">        bump,</span><br><span class="line">        payer = user,</span><br><span class="line">        space = <span class="number">8</span> + DataAccount::INIT_SPACE</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> pda_account: Account&lt;<span class="symbol">&#x27;info</span>, DataAccount&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(InitSpace)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">DataAccount</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> user: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> bump: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [<span class="variable constant_">PDA</span>] = <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">  [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;data&quot;</span>), user.<span class="property">publicKey</span>.<span class="title function_">toBuffer</span>()],</span><br><span class="line">  program.<span class="property">programId</span></span><br><span class="line">);</span><br><span class="line"><span class="title function_">it</span>(<span class="string">&quot;Is initialized!&quot;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> transactionSignature = <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">initialize</span>()</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">user</span>: user.<span class="property">publicKey</span>,</span><br><span class="line">      <span class="attr">pdaAccount</span>: <span class="variable constant_">PDA</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Transaction Signature:&quot;</span>, transactionSignature);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">&quot;Fetch Account&quot;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pdaAccount = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">dataAccount</span>.<span class="title function_">fetch</span>(<span class="variable constant_">PDA</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(pdaAccount, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>You might ask what if the seeds created in client side is not derived from user pubkey as the program defined, the answer is the program will reject the transaction because the PDA won’t meet the constraint.</p>
<h2 id="5-Fees"><a href="#5-Fees" class="headerlink" title="5.Fees"></a>5.Fees</h2><h3 id="Rent-Fees"><a href="#Rent-Fees" class="headerlink" title="Rent Fees"></a>Rent Fees</h3><ol>
<li><p>Rent Calculation:</p>
<ul>
<li>The rent required for an account depends on its data size.</li>
<li>Accounts that don’t maintain enough balance to cover their rent will eventually be deactivated (become inaccessible).</li>
<li>the rent rates of program accounts and data accounts are not same.</li>
</ul>
</li>
<li><p>Rent Exemption</p>
<ul>
<li>Rent is deducted over time from an account’s balance unless it is rent-exempt.</li>
<li>No periodic rent will ever be deducted from the account as long as the balance remains at or above the required rent-exempt threshold.</li>
</ul>
</li>
</ol>
<h3 id="Transaction-Fees"><a href="#Transaction-Fees" class="headerlink" title="Transaction Fees"></a>Transaction Fees</h3><p>Do not forget transaction fees are charged.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/16/rust-0410-extra/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/16/rust-0410-extra/" itemprop="url">Rust lesson 4.9 - Extra</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-11-16T16:17:16+08:00">
                2024-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Extended-topics"><a href="#Extended-topics" class="headerlink" title="Extended topics"></a>Extended topics</h1><h2 id="Deref-and-deref-coercion-with-Vec-examples"><a href="#Deref-and-deref-coercion-with-Vec-examples" class="headerlink" title="Deref and deref coercion with Vec examples"></a><code>Deref</code> and deref coercion with <code>Vec</code> examples</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span>=<span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];</span><br></pre></td></tr></table></figure>

<p>For the <code>v</code>, what are <code>&amp;v</code> and <code>*v</code>?</p>
<h3 id="Dereference-of-v-v"><a href="#Dereference-of-v-v" class="headerlink" title="Dereference of v: *v"></a>Dereference of v: <code>*v</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T, A: Allocator&gt; ops::Deref <span class="keyword">for</span> <span class="title class_">Vec</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = [T];</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;[T] &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; slice::<span class="title function_ invoke__">from_raw_parts</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">as_ptr</span>(), <span class="keyword">self</span>.len) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For type <code>T</code> that implements <code>Deref</code>, Rust treats <code>*t</code> as <code>*(t.deref())</code>.</p>
<p>As we can the source code of <code>Vec</code> listed above, the <code>deref()</code> returns a slice, so <strong><code>*v</code> is a slice</strong>, which is [T]. ( FYI,Array is [T;N], don’t get confused).</p>
<h3 id="Reference-of-v-v"><a href="#Reference-of-v-v" class="headerlink" title="Reference of v: &amp;v"></a>Reference of v: <code>&amp;v</code></h3><p>This is more complex, Rust can decide use <code>&amp;v</code> as:</p>
<ul>
<li>Type inference: What type does the context expect? (&amp;Vec<T> or &amp;[T]).</li>
<li>Deref coercion: If a slice (&amp;[T]) is expected, Rust automatically dereferences the vector.</li>
</ul>
<h4 id="Reference-of-Vec-struct"><a href="#Reference-of-Vec-struct" class="headerlink" title="Reference of Vec struct"></a>Reference of Vec struct</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reference to Vec&lt;T&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">ref_to_vec</span>: &amp;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = &amp;v</span><br></pre></td></tr></table></figure>

<h4 id="Deref-coercion"><a href="#Deref-coercion" class="headerlink" title="Deref coercion"></a>Deref coercion</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="comment">// Slice reference</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;v; <span class="comment">// Deref coercion: &amp;v becomes &amp;[i32]</span></span><br></pre></td></tr></table></figure>

<p>This is tricky, right?</p>
<p><strong>Deref coercion</strong> is a compiler feature that automatically converts a reference to a type into a reference to its target type.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[stable(feature = <span class="string">&quot;rust1&quot;</span>, since = <span class="string">&quot;1.0.0&quot;</span>)]</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T, A: Allocator&gt; ops::Deref <span class="keyword">for</span> <span class="title class_">Vec</span>&lt;T, A&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = [T];</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;[T] &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; slice::<span class="title function_ invoke__">from_raw_parts</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">as_ptr</span>(), <span class="keyword">self</span>.len) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This means, for <code>Vec&lt;T&gt;</code> ‘v’, <code>&amp;v</code> can be coverted to <code>&amp;[t]</code>. This is because of the <code>Deref</code> trait.</p>
<p>What is more, Deref coercion can be done as many times as needed.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyBox</span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">MyBox</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::Target &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">takes_slice</span>(s: &amp;[<span class="type">i32</span>]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_box</span> = <span class="title function_ invoke__">MyBox</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Explicit Deref</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;*my_box; <span class="comment">// `deref()` is called manually</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, slice);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deref Coercion</span></span><br><span class="line">    <span class="title function_ invoke__">takes_slice</span>(&amp;my_box); <span class="comment">// Compiler converts `&amp;MyBox&lt;Vec&lt;i32&gt;&gt;` -&gt; `&amp;Vec&lt;i32&gt;` -&gt; `&amp;[i32]`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>What Happens in Each Case:</p>
<ol>
<li>Explicit Dereferencing (<code>&amp;*my_box</code>):<ul>
<li><code>*my_box</code> calls deref(), yielding <code>*(&amp;Vec&lt;i32&gt;)</code>, which is <code>Vec&lt;i32&gt;</code>.</li>
<li><code>&amp;*my_box</code> is <code>&amp;Vec&lt;i32&gt;</code>, derefed into <code>&amp;[i32]</code>.</li>
</ul>
</li>
<li>Deref Coercion (takes_slice(&amp;my_box)):<ul>
<li>Rust sees takes_slice expects &amp;[i32].</li>
<li>It applies deref() twice:</li>
<li>&amp;MyBox&lt;Vec<i32>&gt; → &amp;Vec<i32>.</li>
<li>&amp;Vec<i32> → &amp;[i32].</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/07/rust-0409-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/07/rust-0409-test/" itemprop="url">Rust lesson 4.9 - Testing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-11-07T21:01:06+08:00">
                2024-11-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Writing-Tests"><a href="#Writing-Tests" class="headerlink" title="Writing Tests"></a>Writing Tests</h1><h2 id="1-Unit-tests"><a href="#1-Unit-tests" class="headerlink" title="1. Unit tests"></a>1. Unit tests</h2><p>Whenever we make a new library project with Cargo, a test module with a test function in it is automatically generated for us.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(left: <span class="type">usize</span>, right: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    left + right</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">it_works</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(result, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this code, the test mod ‘tests’ is generated by rust, and a test function ‘it_works’ as well.</p>
<p>We can create more test mods using <code>#[cfg(test)]</code> annotation, and create test function with <code>#[test]</code> annotation inside test mods.</p>
<p>The <code>use super::*;</code> indicates we can use everything definded in this crate.</p>
<h3 id="checking-test-results"><a href="#checking-test-results" class="headerlink" title="checking test results"></a>checking test results</h3><h4 id="1-assert"><a href="#1-assert" class="headerlink" title="1. assert!"></a>1. <code>assert</code>!</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add_works</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//assert_eq!(result, 4);</span></span><br><span class="line">    <span class="built_in">assert!</span>(result == <span class="number">4</span>, <span class="string">&quot;passed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-Expecting-panics"><a href="#2-Expecting-panics" class="headerlink" title="2. Expecting panics"></a>2. Expecting panics</h4><p>Sometimes, our test is expected to fail with panic as follow:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add_not_works</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span>: <span class="type">usize</span> = <span class="title function_ invoke__">add</span>(<span class="type">usize</span>::MAX, <span class="type">usize</span>::MAX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>#[should_panic]</code> can be used here to let the test pass with panic.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[should_panic]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add_not_works</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span>: <span class="type">usize</span> = <span class="title function_ invoke__">add</span>(<span class="type">usize</span>::MAX, <span class="type">usize</span>::MAX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To be more specific, we can check the expected panic messages:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[should_panic(expected=<span class="string">&quot;expected message&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_panic</span>() &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;actual message&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For the unimplement code,especially,in test-driven development, we can ignore the test function with <code>#[ignore]</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="meta">#[ignore]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">not_code_yet</span>() &#123;</span><br><span class="line">    todo!();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-Using-Result-in-Tests"><a href="#3-Using-Result-in-Tests" class="headerlink" title="3. Using Result&lt;T, E&gt; in Tests"></a>3. Using <code>Result&lt;T, E&gt;</code> in Tests</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">it_works</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result == <span class="number">4</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;two plus two does not equal four&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Integration-tests"><a href="#2-Integration-tests" class="headerlink" title="2. Integration tests"></a>2. Integration tests</h2><p>To create an Integration test, We create a tests directory at the top level of our project directory, next to src. And then we put a <code>integration.rs</code> inside ‘test’.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adder</span><br><span class="line">├── Cargo.lock</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src</span><br><span class="line">│   └── lib.rs</span><br><span class="line">└── tests</span><br><span class="line">    └── integration.rs</span><br></pre></td></tr></table></figure>

<p>The <code>integration.rs</code> is our integration test file, and we can create as many as we need, each file in the tests directory is compiled as its own separate crate.</p>
<h3 id="Submodules-in-Integration-Tests"><a href="#Submodules-in-Integration-Tests" class="headerlink" title="Submodules in Integration Tests"></a>Submodules in Integration Tests</h3><p>To create shared submodules, we need to use the old convention we learnt before.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── Cargo.lock</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src</span><br><span class="line">│   └── lib.rs</span><br><span class="line">└── tests</span><br><span class="line">    ├── common</span><br><span class="line">    │   └── mod.rs</span><br><span class="line">    └── integration_test.rs</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> test_publish_cdbb::add;</span><br><span class="line"><span class="keyword">mod</span> common;</span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">it_adds_two</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (a, b) = common::<span class="title function_ invoke__">setup</span>(); <span class="comment">//function from common</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">res</span> = <span class="title function_ invoke__">add</span>(a, b);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(res, <span class="number">7</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Doc-tests"><a href="#3-Doc-tests" class="headerlink" title="3. Doc-tests"></a>3. Doc-tests</h2><p>Accurately documenting your packages will help other users know how and when to use them. Rust also included doc-tests in the test command, and we can preview the documentation by running <code>cargo doc --open</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// substract number A by number B</span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// assert_eq!(test_publish_cdbb::substract(2,1),1)</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// # Panics</span></span><br><span class="line"><span class="comment">/// ```should_panic</span></span><br><span class="line"><span class="comment">/// test_publish_cdbb::substract(1,2);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">substract</span>(left: <span class="type">usize</span>, right: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    left - right</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, it shows us documentation comments use <code>///</code>, and we can use <code>#</code> to organize our documentation. Here are some commonly used sections:</p>
<ol>
<li><strong>Panics</strong>: The scenarios in which the function being documented could panic.</li>
<li><strong>Errors</strong>: If the function returns a Result, describing the kinds of errors that might occur and what conditions might cause those errors to be returned can be helpful to callers so they can write code to handle the different kinds of errors in different ways.</li>
<li><strong>Safety</strong>: If the function is unsafe to call , there should be a section explaining why the function is unsafe and covering the invariants that the function expects callers to uphold.</li>
</ol>
<h2 id="4-Test-commands"><a href="#4-Test-commands" class="headerlink" title="4. Test commands"></a>4. Test commands</h2><p>Running <code>cargo test</code>:</p>
<ul>
<li>unit tests</li>
<li>integration tests</li>
<li>doc-tests</li>
</ul>
<p>Running <code>cargo test -- --show-output</code> would print values for passing tests as well.</p>
<p>Running <code>cargo test [TEST_NAME]</code> would filter out the other tests. <code>TEST_NAME</code> could be the fullname or part of the fullname.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/03/rust-0408-concurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/03/rust-0408-concurrency/" itemprop="url">Rust lesson 4.8 - Concurrency</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-11-03T19:31:04+08:00">
                2024-11-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h1><h2 id="1-Threads"><a href="#1-Threads" class="headerlink" title="1. Threads"></a>1. Threads</h2><h3 id="Creating-threads"><a href="#Creating-threads" class="headerlink" title="Creating threads"></a>Creating threads</h3><p>To create a new thread, we call the thread::spawn function and pass it a closure</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;i&#125; from the spawned thread!&quot;</span>);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;i&#125; from the main thread!&quot;</span>);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, the result of this code may not come as what we expect, when the main thread end, the spawed thread will be kill too.</p>
<h3 id="Blocking-threads"><a href="#Blocking-threads" class="headerlink" title="Blocking threads"></a>Blocking threads</h3><p>To fix this, we can use <code>join</code>, which would block the main thread until the spawnd thread finishing.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;i&#125; from the spawned thread!&quot;</span>);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;hi number &#123;i&#125; from the main thread!&quot;</span>);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lifetime-in-threads"><a href="#Lifetime-in-threads" class="headerlink" title="Lifetime in threads"></a>Lifetime in threads</h3><p>let us think about this: we create a local variable <code>v</code> and pass it to the spawn thread, what would happen if we drop the <code>v</code>?</p>
<p>To prevent the ambiguity, Rust requires that the closures in thread::spawn only capture ‘static lifetime references. And we will often use <code>move</code> to pass the ownership between threads.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Here&#x27;s a vector: &#123;v:?&#125;&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//v is moved already!</span></span><br><span class="line"></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Threads-communication-with-message-passing"><a href="#2-Threads-communication-with-message-passing" class="headerlink" title="2. Threads communication with message passing"></a>2. Threads communication with message passing</h2><blockquote>
<p>“Do not communicate by sharing memory; instead, share memory by communicating.”</p>
</blockquote>
<p>To accomplish message-sending concurrency, Rust’s standard library provides an implementation of <em>channels</em>.</p>
<p>We create a new channel using the <code>mpsc::channel</code> function; mpsc stands for multiple producer, single consumer.</p>
<h3 id="Message-transmitters"><a href="#Message-transmitters" class="headerlink" title="Message transmitters"></a>Message transmitters</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">val</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>send</code> method returns a <code>Result&lt;T, E&gt; </code>type, in case of the receiver has already been dropped and there’s nowhere to send a value.</p>
<h3 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h3><p>There are two method for receiver to receice messages: <code>recv</code> and <code>try_recv</code>, and both of them would return a <code>Result&lt;T, E&gt;</code>&gt; The difference is <code>recv</code> would <strong>block</strong>, while <code>try_recv</code> not.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">val</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">received</span> = rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Got: &#123;received&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ownership-Transference-in-message-passing"><a href="#Ownership-Transference-in-message-passing" class="headerlink" title="Ownership Transference in message passing"></a>Ownership Transference in message passing</h3><p>Similar to moving ownership to spawned thread. <code>send</code> would take the ownership to prevent data inconsistent.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">val</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hi&quot;</span>);</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="comment">//println!(&quot;val is &#123;val&#125;&quot;); val is moved.</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">received</span> = rx.<span class="title function_ invoke__">recv</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Got: &#123;received&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Sending-Multiple-Values-and-Seeing-the-Receiver-Waiting"><a href="#Sending-Multiple-Values-and-Seeing-the-Receiver-Waiting" class="headerlink" title="Sending Multiple Values and Seeing the Receiver Waiting"></a>Sending Multiple Values and Seeing the Receiver Waiting</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vals</span> = <span class="built_in">vec!</span>[</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hi&quot;</span>),</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;from&quot;</span>),</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;the&quot;</span>),</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;thread&quot;</span>),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> vals &#123;</span><br><span class="line">            tx.<span class="title function_ invoke__">send</span>(val).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">received</span> <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Got: &#123;received&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>rx</code> implements <code>iterator</code>, and would block (or <code>try_iter</code>).</p>
<h3 id="Creating-Multiple-Producers-by-Cloning-the-Transmitter"><a href="#Creating-Multiple-Producers-by-Cloning-the-Transmitter" class="headerlink" title="Creating Multiple Producers by Cloning the Transmitter"></a>Creating Multiple Producers by Cloning the Transmitter</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">tx1</span> = tx.<span class="title function_ invoke__">clone</span>(); <span class="comment">// now there are two producers</span></span><br></pre></td></tr></table></figure>

<h2 id="3-Shared-State-Concurrency"><a href="#3-Shared-State-Concurrency" class="headerlink" title="3. Shared-State Concurrency"></a>3. Shared-State Concurrency</h2><p>Although shared-data is not recommanded, we need to consider scenarios like multiple ownership shared by threads.</p>
<h3 id="Mutexes"><a href="#Mutexes" class="headerlink" title="Mutexes"></a>Mutexes</h3><p>Mutex is an abbreviation for mutual exclusion, only one thread to access data at any given time.</p>
<ul>
<li>You must attempt to acquire the lock before using the data.</li>
<li>When you’re done with the data that the mutex guards, you must unlock the data so other threads can acquire the lock.</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = m.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        *num = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;m = &#123;m:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Mutex&lt;T&gt;</code> is a smart pointer. More accurately, the call to <code>lock</code> returns a smart pointer called <code>MutexGuard</code>, wrapped in a <code>LockResult</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//std::sync::Mutex</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> LockResult&lt;MutexGuard&lt;<span class="symbol">&#x27;_</span>, T&gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//std::sync::LockResult</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">LockResult</span>&lt;Guard&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(Guard),</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(PoisonError&lt;Guard&gt;),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MutexGuard</code> smart pointer implements <code>Deref</code> to point at our inner data; the smart pointer also has a <code>Drop</code> implementation that releases the lock automatically when a <code>MutexGuard</code> goes out of scope. Very similar to the <code>Box&lt;T&gt;</code>.</p>
<h3 id="Sharing-a-Mutex-Between-Multiple-Threads"><a href="#Sharing-a-Mutex-Between-Multiple-Threads" class="headerlink" title="Sharing a Mutex&lt;T&gt; Between Multiple Threads"></a>Sharing a <code>Mutex&lt;T&gt;</code> Between Multiple Threads</h3><p>How to do it?</p>
<h4 id="Can-we-pass-it-to-threads-directly"><a href="#Can-we-pass-it-to-threads-directly" class="headerlink" title="Can we pass it to threads directly?"></a>Can we pass it to threads directly?</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">counter</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>(); <span class="comment">// moved to thread 0</span></span><br><span class="line"></span><br><span class="line">        *num += <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This will not work, because <code>counter</code> is moved in the first round.</p>
<h4 id="Maybe-we-can-do-it-with-Rc"><a href="#Maybe-we-can-do-it-with-Rc" class="headerlink" title="Maybe we can do it with Rc&lt;T&gt;?"></a>Maybe we can do it with <code>Rc&lt;T&gt;</code>?</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">counter</span> = Rc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        *num += <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Looks promising, however this won’t work either.<br>Remember that <code>Rc</code> is short for reference counter, counting the number of references. Sadly, the counter inside is not for concurrenct situations.<br>So the Rc in standard library is not a <code>Send</code>, can not be used in threads.</p>
<h4 id="Fortunately-we-got-Arc"><a href="#Fortunately-we-got-Arc" class="headerlink" title="Fortunately, we got Arc&lt;T&gt;"></a>Fortunately, we got <code>Arc&lt;T&gt;</code></h4><p>Arc<T> is the atomic version of <code>Rc&lt;T&gt;</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>you may or may not notice that <code>counter</code> is immutable but allows mutable reference, yes, it provide interior mutability like <code>RefCell&lt;T&gt;</code>.</p>
<h2 id="4-Sync-and-Send-Traits"><a href="#4-Sync-and-Send-Traits" class="headerlink" title="4. Sync and Send Traits"></a>4. <code>Sync</code> and <code>Send</code> Traits</h2><p>These two allows us write our own concurrency features.<br>They are marker traits, which means we don’t need to implement functions explicitly.</p>
<h3 id="Allowing-Transference-of-Ownership-Between-Threads-with-Send"><a href="#Allowing-Transference-of-Ownership-Between-Threads-with-Send" class="headerlink" title="Allowing Transference of Ownership Between Threads with Send"></a>Allowing Transference of Ownership Between Threads with <code>Send</code></h3><p>The Send marker trait indicates that ownership of values of the type implementing Send can be transferred between threads.<br>Almost every Rust type is Send, but there are some exceptions, including Rc<T>.</p>
<h3 id="Allowing-Access-from-Multiple-Threads-with-Sync"><a href="#Allowing-Access-from-Multiple-Threads-with-Sync" class="headerlink" title="Allowing Access from Multiple Threads with Sync"></a>Allowing Access from Multiple Threads with <code>Sync</code></h3><p>The Sync marker trait indicates that it is safe for the type implementing Sync to be referenced from multiple threads.<br><code>Rc&lt;T&gt;</code>, <code>RefCell&lt;T&gt;</code> and the family of related <code>Cell&lt;T&gt;</code> types are not <code>Sync</code>.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/31/rust-0407-closures/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/31/rust-0407-closures/" itemprop="url">Rust lesson 4.7 - Closures</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-31T21:31:37+08:00">
                2024-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Closures"><a href="#Closures" class="headerlink" title="Closures"></a>Closures</h1><p>Closures are anonymous functions in rust, and they:</p>
<ul>
<li>can be saved in a variable</li>
<li>can be used as arguments in other functions</li>
<li>can capture values from the environment</li>
<li>type annotations are not required, compiler can infer the types from the context most times.</li>
</ul>
<h2 id="1-Capturing-the-Environment-with-Closures"><a href="#1-Capturing-the-Environment-with-Closures" class="headerlink" title="1. Capturing the Environment with Closures"></a>1. Capturing the Environment with Closures</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>()&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">equal_to_x</span>= |n| n==x; <span class="comment">// the closure awares the &#x27;x&#x27;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>=<span class="number">4</span>;</span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-Closure-Type-Inference-and-Annotation"><a href="#2-Closure-Type-Inference-and-Annotation" class="headerlink" title="2. Closure Type Inference and Annotation"></a>2. Closure Type Inference and Annotation</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span>  <span class="title function_">add_one_v1</span>   (x: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123; x + <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">add_one_v2</span> = |x: <span class="type">u32</span>| <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123; x + <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">add_one_v3</span> = |x|             &#123; x + <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">add_one_v4</span> = |x|               x + <span class="number">1</span>  ;</span><br></pre></td></tr></table></figure>

<p>Compiler can infer the types of parameters and return types most cases, however, compiler will infer one concrete type for each.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">example_closure</span> = |x| x;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="title function_ invoke__">example_closure</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>)); <span class="comment">//the type of the closure is String from now on.</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">n</span> = <span class="title function_ invoke__">example_closure</span>(<span class="number">5</span>); <span class="comment">//won&#x27;t work.</span></span><br></pre></td></tr></table></figure>

<h2 id="3-Capturing-References-or-Moving-Ownership"><a href="#3-Capturing-References-or-Moving-Ownership" class="headerlink" title="3. Capturing References or Moving Ownership"></a>3. Capturing References or Moving Ownership</h2><p>Closures can capture values form their in three ways:</p>
<ul>
<li>borrowing immutably</li>
<li>borrowing mutably</li>
<li>taking ownership</li>
</ul>
<p>And the closure <strong>itself</strong> will decide which to use.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">list</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Before defining closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line">    <span class="comment">//the parameter need to declared first!</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">only_borrows</span> = || <span class="built_in">println!</span>(<span class="string">&quot;From closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Before calling closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">only_borrows</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;After calling closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">list</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Before defining closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">borrows_mutably</span> = || list.<span class="title function_ invoke__">push</span>(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">borrows_mutably</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;After calling closure: &#123;list:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Taking-the-ownership"><a href="#Taking-the-ownership" class="headerlink" title="Taking the ownership"></a>Taking the ownership</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;x = &#123;:?&#125;&quot;</span>, x);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">equal_to_x</span> = <span class="keyword">move</span> |n| n == x; <span class="comment">// x is moved to the clousre</span></span><br><span class="line"><span class="comment">//println!(&quot;x = &#123;:?&#125;&quot;, x); this is invalid</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));</span><br></pre></td></tr></table></figure>

<h2 id="4-Moving-Captured-Values-Out-of-Closures-and-the-Fn-Traits"><a href="#4-Moving-Captured-Values-Out-of-Closures-and-the-Fn-Traits" class="headerlink" title="4. Moving Captured Values Out of Closures and the Fn Traits"></a>4. Moving Captured Values Out of Closures and the Fn Traits</h2><p>How the closure’s body handles the values determines the way it capture the values. Specificly, which traits the closure implements.</p>
<ol>
<li><code>FnOnce</code>: move values out of its body, once only.</li>
<li><code>FnMut</code>: mutate the captured values, more that once.</li>
<li><code>Fn</code>: immutate the captured values, or capture nothing; multiple times concurrently</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/30/rust-0405-traits_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/30/rust-0405-traits_2/" itemprop="url">Rust lesson 4.5 - Advanced Traits</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-30T20:04:13+08:00">
                2024-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Advanced-Traits"><a href="#Advanced-Traits" class="headerlink" title="Advanced Traits"></a>Advanced Traits</h1><p>We have discussed trait in <a target="_blank" rel="noopener" href="https://caodanbobo.github.io/2024/10/08/rust-0303-functions/">function</a>, let us check out the advanced features of Traits.</p>
<h2 id="1-Associated-Types"><a href="#1-Associated-Types" class="headerlink" title="1. Associated Types"></a>1. Associated Types</h2><p>Associated types connect a t<strong>ype placeholder</strong> with a trait such that the trait method definitions can use these placeholder types in their signatures.</p>
<p>In this example, the associate type <code>item</code> is used as the placeholder for return type.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">u32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This can be done by generics as well:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There difference between these two is:</p>
<ul>
<li>Traits with generics can be implemented multiple times for each concrete types.</li>
<li>With associated types, we can only implement a trait once on a type.</li>
</ul>
<h2 id="2-Default-Generic-Type-Parameters-and-Operator-Overloading"><a href="#2-Default-Generic-Type-Parameters-and-Operator-Overloading" class="headerlink" title="2. Default Generic Type Parameters and Operator Overloading"></a>2. Default Generic Type Parameters and Operator Overloading</h2><p>When declaring the trait, we can specift a default concrete type as default as Parameters type with <code>&lt;PlaceholderType=ConcreteType&gt;</code> syntax.</p>
<p>Following codes is Trait <code>std::ops::Add</code>, it also an example showing us how to overloading operator defined in <code>std::ops</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Add</span>&lt;Rhs = <span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Required method</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, rhs: Rhs) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>::Output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>whem implemt it on <code>Point</code>, the second parameter of ‘add’ is also <code>Point</code> itself:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Add;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Copy, Clone, PartialEq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//impl Add&lt;Point&gt; for Poing</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Add</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = Point;</span><br><span class="line">    <span class="comment">// Point as Self</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, other: Point) <span class="punctuation">-&gt;</span> Point &#123;</span><br><span class="line">        Point &#123;</span><br><span class="line">            x: <span class="keyword">self</span>.x + other.x,</span><br><span class="line">            y: <span class="keyword">self</span>.y + other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the default type can be replaced as well:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Add;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Millimeters</span>(<span class="type">u32</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">u32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Add</span>&lt;Meters&gt; <span class="keyword">for</span> <span class="title class_">Millimeters</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = Millimeters;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, other: Meters) <span class="punctuation">-&gt;</span> Millimeters &#123;</span><br><span class="line">        <span class="title function_ invoke__">Millimeters</span>(<span class="keyword">self</span>.<span class="number">0</span> + (other.<span class="number">0</span> * <span class="number">1000</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>Rhs</code> type is customized to <code>Meters</code>.</p>
<h2 id="3-Fully-Qualified-Syntax"><a href="#3-Fully-Qualified-Syntax" class="headerlink" title="3. Fully Qualified Syntax"></a>3. Fully Qualified Syntax</h2><p>Sometimes, There are methods or functions from different traits sharing same name. How do we distinguish them from each other?</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Pilot</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Wizard</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Human</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Pilot</span> <span class="keyword">for</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;This is your captain speaking.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Wizard</span> <span class="keyword">for</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Up!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;*waving arms furiously*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, There are 3 <code>fly</code> methods in <code>Human</code>, and we can use the trait name to clarify the one we want to call:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">person</span> = Human;</span><br><span class="line">    Pilot::<span class="title function_ invoke__">fly</span>(&amp;person); <span class="comment">//This is your captain speaking.</span></span><br><span class="line">    Wizard::<span class="title function_ invoke__">fly</span>(&amp;person);<span class="comment">//Up!</span></span><br><span class="line">    person.<span class="title function_ invoke__">fly</span>(); <span class="comment">//waving arms furiously</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, the associate functions wound not work like this with trait name, fully qualified syntax is required:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">baby_name</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dog</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">baby_name</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Spot&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">baby_name</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;puppy&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;A baby dog is called a &#123;&#125;&quot;</span>, Dog::<span class="title function_ invoke__">baby_name</span>()); <span class="comment">//Spot</span></span><br><span class="line">    <span class="comment">//this next line will not work</span></span><br><span class="line">    <span class="comment">//println!(&quot;A baby dog is called a &#123;&#125;&quot;, Animal::baby_name());</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;A baby dog is called a &#123;&#125;&quot;</span>, &lt;Dog <span class="keyword">as</span> Animal&gt;::<span class="title function_ invoke__">baby_name</span>()); <span class="comment">//puppy</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Supertraits"><a href="#4-Supertraits" class="headerlink" title="4. Supertraits"></a>4. Supertraits</h2><p>if we want to add extra functionalities on another trait, the trait is relied on is call <em>supertrait</em>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">OutlinePrint</span>: fmt::Display &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">outline_print</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">output</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = output.<span class="title function_ invoke__">len</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">4</span>));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;*&#123;&#125;*&quot;</span>, <span class="string">&quot; &quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">2</span>));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;* &#123;output&#125; *&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;*&#123;&#125;*&quot;</span>, <span class="string">&quot; &quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">2</span>));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>we create a trait <code>OutlinePrint</code> relying on <code>fmt::Display</code> which provides <code>to_string</code> method.</p>
<p>To implement this <code>OutlinePrint</code>, the type must implement the <code>fmt::Display</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">OutlinePrint</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/26/rust-0406-Macros/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/26/rust-0406-Macros/" itemprop="url">Rust lesson 4.6 - Macros</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-26T20:37:50+08:00">
                2024-10-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Macros"><a href="#Macros" class="headerlink" title="Macros"></a>Macros</h1><ul>
<li><em>declarative</em><ul>
<li><code>macro_rules!</code></li>
</ul>
</li>
<li><em>procedural</em><ul>
<li>Custom <code>#[derive]</code> macros</li>
<li>Attribute-like macros</li>
<li>Function-like macros</li>
</ul>
</li>
</ul>
<h2 id="1-What-are-macros"><a href="#1-What-are-macros" class="headerlink" title="1. What are macros"></a>1. What are macros</h2><p>A way of writing code that writes other code, aka. <em>metaprogramming</em>. For example:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">u32</span>&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//vec![1, 2, 3] would be replaced by following block</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp_vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">    temp_vec.<span class="title function_ invoke__">push</span>(<span class="number">3</span>);</span><br><span class="line">    temp_vec</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In addition, camparing to functions, macros:</p>
<ul>
<li>Operate at compile time, they can produce code that implements traits for type</li>
<li>can take a variable number of parameters</li>
<li>must be defined or brought into scope before you call them in a file</li>
</ul>
<h2 id="2-Declarative-Macros"><a href="#2-Declarative-Macros" class="headerlink" title="2. Declarative Macros"></a>2. Declarative Macros</h2><p>Let us check out <code>vec!</code> under the hood.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> vec &#123;</span><br><span class="line">    ( $( $x:expr ),* ) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp_vec</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            $(</span><br><span class="line">                temp_vec.<span class="title function_ invoke__">push</span>($x);</span><br><span class="line">            )*</span><br><span class="line">            temp_vec</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>#[macro_export]</code> indicates that this macros will be available for code brought the crate.</li>
<li><code>macro_rules! vec&#123;&#125;</code> defines the macro.</li>
<li><code>()=&gt;&#123;&#125;</code> is smililar to the pattern in <code>match</code> flow, but it matchs against the syntax.</li>
<li><code>&amp;</code> is for variable that the code matching the pattern</li>
<li><code>$x:expr</code> indicates this is a pattern for expression, and naming it <code>$x</code>.</li>
<li><code>$( $x:expr ),*</code> is the pattern that matches code with multiple expression separated by ‘,’.</li>
<li><code>$()*</code> inside the arm is generated for each part matches <code>$()</code>.</li>
</ul>
<h2 id="3-Procedural-Macros"><a href="#3-Procedural-Macros" class="headerlink" title="3. Procedural Macros"></a>3. Procedural Macros</h2><p>Procedural macros accept some code as an input, operate on that code, and produce some code as an output.</p>
<h3 id="3-1-Custom-derive-Macro"><a href="#3-1-Custom-derive-Macro" class="headerlink" title="3.1 Custom derive Macro"></a>3.1 Custom derive Macro</h3><p>Used to implement traits for structs or enums automatically by adding <code>#[derive(TraitName)]</code>. These macros are marked with <code>#[proc_macro_derive]</code> and are often used for common traits like Debug or Clone, but custom derive macros can be created to automate repetitive implementations.</p>
<h3 id="3-2-Attribute-like-Macro"><a href="#3-2-Attribute-like-Macro" class="headerlink" title="3.2 Attribute-like Macro"></a>3.2 Attribute-like Macro</h3><p>These are applied to items like functions or modules with <code>#[proc_macro_attribute]</code>. They allow you to add custom attributes that modify the behavior of the decorated item.</p>
<h3 id="3-1-Function-like-Macro"><a href="#3-1-Function-like-Macro" class="headerlink" title="3.1 Function-like Macro"></a>3.1 Function-like Macro</h3><p>These resemble functions and can be used anywhere you’d use a regular function call. They are defined with <code>#[proc_macro]</code> and are commonly used for code generation based on input.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/22/rust-0404-rc&refcell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/22/rust-0404-rc&refcell/" itemprop="url">Rust lesson 4.4 - Smart Pointer II</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-22T21:52:05+08:00">
                2024-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Smart-Pointer-Part-II"><a href="#Smart-Pointer-Part-II" class="headerlink" title="Smart Pointer Part II"></a>Smart Pointer Part II</h1><h2 id="1-Rc"><a href="#1-Rc" class="headerlink" title="1. Rc&lt;T&gt;"></a>1. <code>Rc&lt;T&gt;</code></h2><p><code>Rc&lt;T&gt;</code> is design to handle multiple ownerships cases, e.g., graphs, tree.</p>
<p>Imgine there is linked list:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b -&gt; 3 -&gt;</span><br><span class="line">         a -&gt; 5 -&gt; 10</span><br><span class="line">c -&gt; 4 -&gt;</span><br></pre></td></tr></table></figure>

<p><strong>How are gonna represent it in rust?</strong></p>
<h3 id="1-Using-Box"><a href="#1-Using-Box" class="headerlink" title="1. Using Box"></a>1. Using Box<T></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//code with errors</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, <span class="type">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Nil))));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(a));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">4</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(a)); <span class="comment">// use of moved value &#x27;a&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Box&lt;T&gt;</code> is for single ownership, it does not fit here.</p>
<h3 id="2-Using-references"><a href="#2-Using-references" class="headerlink" title="2. Using references"></a>2. Using references</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, &amp;<span class="symbol">&#x27;a</span> List&lt;<span class="symbol">&#x27;a</span>&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, &amp;<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, &amp;Nil));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, &amp;a);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">4</span>, &amp;a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This would work with carefully handled lifetimes, not for every scenario.</p>
<h3 id="3-Rc"><a href="#3-Rc" class="headerlink" title="3. Rc&lt;T&gt;"></a>3. <code>Rc&lt;T&gt;</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, Rc::<span class="title function_ invoke__">new</span>(Nil)))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count after creating a = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a)); <span class="comment">//1</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count after creating b = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a)); <span class="comment">//2</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">4</span>, Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;count after creating c = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));<span class="comment">//3</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count after c goes out of scope = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));<span class="comment">//2, compiler drop c</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Via <strong>immutable</strong> references, Rc<T> allows you to share data between multiple parts of your program for <strong>reading only</strong>.</p>
<h3 id="How-Rc-works"><a href="#How-Rc-works" class="headerlink" title="How Rc&lt;T&gt; works"></a>How <code>Rc&lt;T&gt; </code>works</h3><p>Rc is abbreviation of Reference Counting,</p>
<ul>
<li>it type keeps track of the number of references to a value:<ul>
<li><code>Rc::new</code> or <code>Rc::clone</code> would increase the counter by 1.</li>
<li><code>drop</code> would decrease the counter by 1.</li>
</ul>
</li>
<li>if the number of reference goes to 0, the Rc<T> will be clean up completely.</li>
</ul>
<h2 id="2-RefCell"><a href="#2-RefCell" class="headerlink" title="2. RefCell&lt;T&gt;"></a>2. <code>RefCell&lt;T&gt;</code></h2><p>Rc<T> is immutable reference for read-only, what if we’d like to modify the list in former example?</p>
<p><strong>Interior mutability</strong> is a design pattern in Rust that allows you to mutate data even when there are immutable references to that data:<br><em><strong>it bypasses the compiler borrow checker using <code>unsafe</code>.</strong></em></p>
<p>we are going to look at the RefCell<T>, let us compare it with Rc<T> and Box<T> first.</p>
<table>
<thead>
<tr>
<th></th>
<th><code>Rc&lt;T&gt;</code></th>
<th><code>Box&lt;T&gt;</code></th>
<th><code>RefCell&lt;T&gt;</code></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Immutable Borrowing</strong></td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td><strong>Mutate Borrowing</strong></td>
<td>no</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td><strong>Multiple Owners</strong></td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td><strong>Borrow Check</strong></td>
<td>compile time</td>
<td>compile time</td>
<td>runtime</td>
</tr>
</tbody></table>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">rc_1</span> = RefCell::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ref_01</span> = rc_1.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ref_02</span> = rc_1.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ref_01= &#123;ref_01:?&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ref_02= &#123;ref_02:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">m_ref_01</span> = rc_1.<span class="title function_ invoke__">borrow_mut</span>();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;m_ref_01= &#123;m_ref_01:?&#125;&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="How-RefCell-works"><a href="#How-RefCell-works" class="headerlink" title="How RefCell&lt;T&gt; works"></a>How <code>RefCell&lt;T&gt; </code>works</h3><ul>
<li><code>RefCell&lt;T&gt;</code> keeps track of the number of active smart pointer<ul>
<li><code>Ref&lt;T&gt;</code> is created and returned from <code>borrow</code>, each of them is a immutable reference.</li>
<li><code>RefMut&lt;T&gt;</code> is created and returned from <code>borrow_mut</code>, it is the mutable reference.</li>
</ul>
</li>
<li><code>RefCell&lt;T&gt;</code> follows reference borrow rules. However the borrow check is performed at runtime, panic if violations occur.</li>
</ul>
<h3 id="Having-Multiple-Owners-of-Mutable-Data-by-Combining-Rc-and-RefCell"><a href="#Having-Multiple-Owners-of-Mutable-Data-by-Combining-Rc-and-RefCell" class="headerlink" title="Having Multiple Owners of Mutable Data by Combining Rc&lt;T&gt; and RefCell&lt;T&gt;"></a>Having Multiple Owners of Mutable Data by Combining <code>Rc&lt;T&gt; </code>and <code>RefCell&lt;T&gt;</code></h3><p>A common way to use <code>RefCell&lt;T&gt; </code>is in combination with <code>Rc&lt;T&gt;</code>. Recall that <code>Rc&lt;T&gt;</code> lets you have multiple owners of some data, but it only gives immutable access to that data. If you have an <code>Rc&lt;T&gt; </code>that holds a <code>RefCell&lt;T&gt;,</code> you can get a value that can have multiple owners and that you can mutate!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(Rc&lt;RefCell&lt;<span class="type">i32</span>&gt;&gt;, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;value), Rc::<span class="title function_ invoke__">new</span>(Nil)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Cons</span>(Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(<span class="number">3</span>)), Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Cons</span>(Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(<span class="number">4</span>)), Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line"></span><br><span class="line">    *value.<span class="title function_ invoke__">borrow_mut</span>() += <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a after = &#123;a:?&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b after = &#123;b:?&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;c after = &#123;c:?&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//a after = Cons(RefCell &#123; value: 15 &#125;, Nil)</span></span><br><span class="line"><span class="comment">//b after = Cons(RefCell &#123; value: 3 &#125;, Cons(RefCell &#123; value: 15 &#125;, Nil))</span></span><br><span class="line"><span class="comment">//c after = Cons(RefCell &#123; value: 4 &#125;, Cons(RefCell &#123; value: 15 &#125;, Nil))</span></span><br></pre></td></tr></table></figure>

<h2 id="How-to-prevent-memory-leak"><a href="#How-to-prevent-memory-leak" class="headerlink" title="How to prevent memory leak?"></a>How to prevent memory leak?</h2><h3 id="Reference-Cycle"><a href="#Reference-Cycle" class="headerlink" title="Reference Cycle"></a>Reference Cycle</h3><p>Since <code>RefCell&lt;T&gt;</code> allows mutable borrow, <code>and Rc&lt;T&gt;</code> allows multiple ownership, we can use them to create reference cycle leading to memory leak.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::List::&#123;Cons, Nil&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, RefCell&lt;Rc&lt;List&gt;&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">tail</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;RefCell&lt;Rc&lt;List&gt;&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Cons</span>(_, item) =&gt; <span class="title function_ invoke__">Some</span>(item),</span><br><span class="line">            Nil =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>In this code example, <code>Cons</code> is a tuple variant, and the second element is a mutable multiple-ownerable <code>List</code>.To create a reference cycle, we can create two <code>List</code> and let them own each other.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, RefCell::<span class="title function_ invoke__">new</span>(Rc::<span class="title function_ invoke__">new</span>(Nil)))); <span class="comment">// a -&gt; Nil</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a initial rc count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a next item = &#123;:?&#125;&quot;</span>, a.<span class="title function_ invoke__">tail</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, RefCell::<span class="title function_ invoke__">new</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;a)))); <span class="comment">//b -&gt; a -&gt; Nil</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a rc count after b creation = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b initial rc count = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b next item = &#123;:?&#125;&quot;</span>, b.<span class="title function_ invoke__">tail</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(link) = a.<span class="title function_ invoke__">tail</span>() &#123;</span><br><span class="line">        *link.<span class="title function_ invoke__">borrow_mut</span>() = Rc::<span class="title function_ invoke__">clone</span>(&amp;b); <span class="comment">// a &lt;-&gt; b</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b rc count after changing a = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b)); <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a rc count after changing a = &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a)); <span class="comment">//2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Uncomment the next line to see that we have a cycle;</span></span><br><span class="line">    <span class="comment">// it will overflow the stack</span></span><br><span class="line">    <span class="comment">// println!(&quot;a next item = &#123;:?&#125;&quot;, a.tail());</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At the end of <code>main</code>, rust would <em>drop</em> both <code>a</code> and <code>b</code>. However, the the strong_count of Rc<List> will never reach 0, the memory allocated will remain uncollected forever.</p>
<h3 id="Weak"><a href="#Weak" class="headerlink" title="Weak&lt;T&gt;"></a><code>Weak&lt;T&gt;</code></h3><p>There is <code>weak_count</code> similar to <code>strong_count</code> we learnt previously, They both are counter of the reference of <code>Rc&lt;T&gt;</code>. The main difference between them is that the value of weak_count won’t affect the memory cleanup.</p>
<ul>
<li><code>Rc::downgrade()</code> return a <code>Weak&lt;T&gt;</code> of the <code>Rc&lt;T&gt;</code> instance.</li>
<li><code>Rc::upgrade()</code> return a <code>Option&lt;Rc&lt;T&gt;&gt;</code> of the <code>Weak&lt;T&gt;</code> instance. This is because the value that Weak<T> references might dropped already.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/22/rust-0403-lifetime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/22/rust-0403-lifetime/" itemprop="url">Rust lesson 4.3 - lifetime</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-22T20:00:46+08:00">
                2024-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Undstanding-Lifetime"><a href="#Undstanding-Lifetime" class="headerlink" title="Undstanding Lifetime"></a>Undstanding Lifetime</h1><p>Lifetimes are Rust’s way of ensuring that references are always valid. The compiler checks that the lifetime of a reference is never longer than the lifetime of the data it points to, preventing dangling references.</p>
<h2 id="The-Borrow-checker"><a href="#The-Borrow-checker" class="headerlink" title="The Borrow checker"></a>The Borrow checker</h2><p>The <strong>borrow checker</strong> compares scopes to determine whether all borrows are valid.<br>In following example, variable <code>r</code> is a reference to <code>x</code>, but the lifetime of <code>r</code> is <code>&#39;a</code>, which is longer than <code>x</code>‘s, and <strong>this is Invalid</strong>: <code>r</code> will be a dangling reference after the compiler <em>drop</em> <code>x</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//code with errors</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span>;                <span class="comment">// ---------+-- &#x27;a</span></span><br><span class="line">                          <span class="comment">//          |</span></span><br><span class="line">    &#123;                     <span class="comment">//          |</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;        <span class="comment">// -+-- &#x27;b  |</span></span><br><span class="line">        r = &amp;x;           <span class="comment">//  |       |</span></span><br><span class="line">    &#125;                     <span class="comment">// -+       |</span></span><br><span class="line">                          <span class="comment">//          |</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;r: &#123;r&#125;&quot;</span>);   <span class="comment">//          |</span></span><br><span class="line">&#125;                         <span class="comment">// ---------+</span></span><br></pre></td></tr></table></figure>

<h2 id="Lifetime-Annotation"><a href="#Lifetime-Annotation" class="headerlink" title="Lifetime Annotation"></a>Lifetime Annotation</h2><p>Sometimes, the compiler has no a idea what lifetime time of borrows would be. In following example, the lifetime of what <code>longest</code> returns varies.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//code with errors</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>(x: &amp;<span class="type">str</span>, y: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So <strong>life annotation</strong> is intruduced to describe the lifetime of references expilicitly.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;i32        // a reference</span><br><span class="line">&amp;&#x27;a i32     // a reference with an explicit lifetime</span><br><span class="line">&amp;&#x27;a mut i32 // a mutable reference with an explicit lifetime</span><br></pre></td></tr></table></figure>

<h3 id="How-borrow-checkers-checks-the-lifetimes"><a href="#How-borrow-checkers-checks-the-lifetimes" class="headerlink" title="How borrow checkers checks the lifetimes"></a>How borrow checkers checks the lifetimes</h3><p>Here are some examples for us to observe how compile comparing the scopes of borrows:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;longer one&quot;</span>);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;shorter&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result_1</span> = <span class="title function_ invoke__">longest</span>(&amp;x, &amp;y);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;longest is &#123;&#125;&quot;</span>, result_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result_2</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;shorter&quot;</span>);</span><br><span class="line">        result_2 = <span class="title function_ invoke__">longest</span>(&amp;x, &amp;y);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;longest is &#123;&#125;&quot;</span>, result_2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result_3</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;shorter&quot;</span>);</span><br><span class="line">        result_3 = <span class="title function_ invoke__">longest</span>(&amp;x, &amp;y); <span class="comment">//`y` does not live long enough</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;longest is &#123;&#125;&quot;</span>, result_3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result_4</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;shorter&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">z</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;local longer&quot;</span>);</span><br><span class="line">        result_4 = <span class="title function_ invoke__">longest</span>(&amp;z, &amp;y); <span class="comment">//both z, y do not live long enough</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;longest is &#123;&#125;&quot;</span>, result_4);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can tell that the lifetime of what <code>longest</code> return should be the shortest.</p>
<h3 id="Lifetime-Elision"><a href="#Lifetime-Elision" class="headerlink" title="Lifetime Elision"></a>Lifetime Elision</h3><p>You may have noticed that in our pervious learning, the lifetime annotation is not always required. if the codes fits the <em>lifetime elision</em> rules, you don’t need to write the lifetimes explicitly.</p>
<ol>
<li>The compiler assigns a lifetime parameter to each parameter that’s a reference.</li>
<li>If there is exactly one <strong>input</strong> lifetime parameter, that lifetime is assigned to all <strong>output</strong> lifetime parameters.</li>
<li>if there are multiple <strong>input</strong> lifetime parameters, but one of them is <strong>&amp;self</strong> or <strong>&amp;mut self</strong> because this is a method, the lifetime of self is assigned to <strong>all output</strong> lifetime parameters.</li>
</ol>
<h3 id="In-Structs"><a href="#In-Structs" class="headerlink" title="In Structs"></a>In Structs</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ImportantExcerpt</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    part: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The lifetime of instances of <code>ImportantExcerpt</code> can not out live the fields’ lifetimes:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ImportantExcerpt</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    part_a: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">    part_b: &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>()&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;longer one&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">j</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;shorter&quot;</span>);</span><br><span class="line">        j = ImportantExcerpt &#123;</span><br><span class="line">            part_a: &amp;x,</span><br><span class="line">            part_b: &amp;y, <span class="comment">//invalid here, `y` does not live long enough</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, j);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="In-Methods"><a href="#In-Methods" class="headerlink" title="In Methods"></a>In Methods</h3><ul>
<li>Annotation after <code>impl</code></li>
<li>Annotation after struct name</li>
<li>since they are methods, they fit elision rule#3</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>&gt; ImportantExcerpt&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">level</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="The-Static-Lifetime"><a href="#The-Static-Lifetime" class="headerlink" title="The Static Lifetime"></a>The Static Lifetime</h2><p>One special lifetime we need to discuss is <code>&#39;static</code>, which denotes that the affected reference can live for the entire duration of the program. All <strong>string literals</strong> have the <code>&#39;static</code> lifetime, which we can annotate as follows:<br><code>let s: &amp;&#39;static str = &quot;I have a static lifetime.&quot;;</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/20/rust-0402-Generic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/20/rust-0402-Generic/" itemprop="url">Rust lesson 4.2 - Generic</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-20T19:14:11+08:00">
                2024-10-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Introducing-Generic"><a href="#Introducing-Generic" class="headerlink" title="Introducing Generic"></a>Introducing Generic</h1><p>Generics in Rust allow you to write flexible and reusable code by parameterizing types.</p>
<h2 id="1-Generic-Functions"><a href="#1-Generic-Functions" class="headerlink" title="1. Generic Functions"></a>1. Generic Functions</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">largest</span>&lt;T: std:::cmp::<span class="built_in">PartialOrd</span>&gt;(list: &amp;[T]) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">largest</span> = &amp;list[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> list.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> item &gt; largest &#123;</span><br><span class="line">            largest = item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    largest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Generic-Structs"><a href="#2-Generic-Structs" class="headerlink" title="2. Generic Structs"></a>2. Generic Structs</h2><h3 id="Single-type"><a href="#Single-type" class="headerlink" title="Single type"></a>Single type</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: T,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">integer</span> = Point &#123; x: <span class="number">5</span>, y: <span class="number">10</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">float</span> = Point &#123; x: <span class="number">1.0</span>, y: <span class="number">4.0</span> &#125;;</span><br><span class="line">    <span class="comment">//let mixed = Point &#123; x: 1.0, y: 5 &#125;;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multiple-types"><a href="#Multiple-types" class="headerlink" title="Multiple types"></a>Multiple types</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T, U&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: U,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">both_integer</span> = Point &#123; x: <span class="number">5</span>, y: <span class="number">10</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">both_float</span> = Point &#123; x: <span class="number">1.0</span>, y: <span class="number">4.0</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">integer_and_float</span> = Point &#123; x: <span class="number">5</span>, y: <span class="number">4.0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Generic-Methods"><a href="#3-Generic-Methods" class="headerlink" title="3. Generic Methods"></a>3. Generic Methods</h2><p><strong>Two rulses:</strong></p>
<ul>
<li>For the generic parameters after <code>impl</code>: Same as the struct definition.</li>
<li>For methods: need to cover the non-struct ones. for ‘mixup’ in the example, X1,X2 are declared in the <code>impl</code>, so the method has to declare the other 2.</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;X1, Y1&gt; &#123;</span><br><span class="line">    x: X1,</span><br><span class="line">    y: Y1,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;X1, Y1&gt; Point&lt;X1, Y1&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">mixup</span>&lt;X2, Y2&gt;(<span class="keyword">self</span>, other: Point&lt;X2, Y2&gt;) <span class="punctuation">-&gt;</span> Point&lt;X1, Y2&gt; &#123;</span><br><span class="line">        Point &#123;</span><br><span class="line">            x: <span class="keyword">self</span>.x,</span><br><span class="line">            y: other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Point &#123; x: <span class="number">5</span>, y: <span class="number">10.4</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = Point &#123; x: <span class="string">&quot;Hello&quot;</span>, y: <span class="string">&#x27;c&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3</span> = p1.<span class="title function_ invoke__">mixup</span>(p2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;p3.x = &#123;&#125;, p3.y = &#123;&#125;&quot;</span>, p3.x, p3.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Generic-with-const"><a href="#4-Generic-with-const" class="headerlink" title="4.Generic with const"></a>4.Generic with const</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for array with length fixed to 3.</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array</span>(arr: [<span class="number">132</span>;<span class="number">3</span>])&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//for slices</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array</span>&lt;T: std::fmt::<span class="built_in">Debug</span>&gt;(arr: &amp;[T])&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//for array with any length</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array</span>&lt;T: std::fmt::<span class="built_in">Debug</span>, <span class="keyword">const</span> N:<span class="type">usize</span>&gt;(arr: [T;N])&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-Performance"><a href="#5-Performance" class="headerlink" title="5. Performance"></a>5. Performance</h2><ul>
<li><strong>Performance in compilation</strong>: Costly. Monomorphization is the process of turning generic code into specific code by filling in the concrete types that are used when compiled. Which means rust would generate code for the concrete types the generic code is called with.</li>
<li><strong>Performance in runtime</strong>: No extra cost, since code for the concrete types is already generated.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
