<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/13/rust-0306-match/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/13/rust-0306-match/" itemprop="url">Rust lesson 3.5 - match</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-13T16:37:15+08:00">
                2024-10-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="let’s-talk-about-the-ownership-in-match"><a href="#let’s-talk-about-the-ownership-in-match" class="headerlink" title="let’s talk about the ownership in match"></a>let’s talk about the ownership in <code>match</code></h1><h2 id="Bindings-and-ownerships-in-match"><a href="#Bindings-and-ownerships-in-match" class="headerlink" title="Bindings and ownerships in match"></a>Bindings and ownerships in <code>match</code></h2><ol>
<li>Ownship is moved by default<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">t</span>:T = T::<span class="title function_ invoke__">new</span>();</span><br><span class="line"> <span class="keyword">match</span> t &#123;</span><br><span class="line">     _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;processing&quot;</span>),</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// t is moved to the match and can not be accessed</span></span><br><span class="line"> <span class="comment">//println!(&quot;after match t is &#123;:?&#125;&quot;, t)</span></span><br></pre></td></tr></table></figure>
If the T is derived from ‘Copy’, a copy of it is passed to the match, the ownership will not be moved.</li>
<li>Borrowing<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">match</span> &amp;x &#123;</span><br><span class="line">    val =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Matched: &#123;&#125;&quot;</span>, val),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// `x` is still accessible here because it was borrowed.</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;x is still: &#123;&#125;&quot;</span>, x);</span><br></pre></td></tr></table></figure></li>
<li>Mutable binding<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">match</span> &amp;<span class="keyword">mut</span> x &#123;</span><br><span class="line">    val =&gt; val.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot; world&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// `x` has been modified through the mutable reference.</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;x is now: &#123;&#125;&quot;</span>, x);</span><br></pre></td></tr></table></figure>
As we mentioned in in the ownership chapter, the exclusive access to <code>x </code>will be return to it after <code>val</code> is out of scope.</li>
</ol>
<h2 id="2-What-about-the-variable-is-an-Option"><a href="#2-What-about-the-variable-is-an-Option" class="headerlink" title="2. What about the variable is an Option"></a>2. What about the variable is an <code>Option</code></h2><p>The “ownership moved by rule” applies to <code>Option</code> as well, we will focus on the value inside.</p>
<ol>
<li><p>Ownship is moved by default</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">my_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">some_string</span> = <span class="title function_ invoke__">Some</span>(my_string); <span class="comment">// my_string is moved to some_string</span></span><br><span class="line"><span class="keyword">match</span> some_string &#123;</span><br><span class="line">     <span class="comment">// my_string is moved to s1 from some_string</span></span><br><span class="line">    <span class="title function_ invoke__">Some</span>(s1) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;the value is &#123;&#125;&quot;</span>, s1),</span><br><span class="line">    <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;nothing here&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//both my_string and some_string are consumed</span></span><br></pre></td></tr></table></figure></li>
<li><p>Borrowing</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">my_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">some_string</span> = <span class="title function_ invoke__">Some</span>(&amp;my_string); <span class="comment">//ref</span></span><br><span class="line"><span class="keyword">match</span> some_string &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(s1: &amp;<span class="type">String</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;the value is &#123;&#125;&quot;</span>, s1),</span><br><span class="line">    <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;nothing here&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;some_string is &#123;:?&#125;&quot;</span>, my_string);</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">my_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">some_string</span> = <span class="title function_ invoke__">Some</span>(my_string);</span><br><span class="line"><span class="keyword">match</span> some_string &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(<span class="keyword">ref</span> s1: &amp;<span class="type">String</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;the value is &#123;&#125;&quot;</span>, s1),</span><br><span class="line">    <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;nothing here&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;some_string is &#123;:?&#125;&quot;</span>, my_string);</span><br></pre></td></tr></table></figure>

<p><code>ref</code> allows s1 to borrow the inner value of some_string, preventing moving the Option.</p>
</li>
<li><p>Mutable binding</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">my_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">some_string</span> = <span class="title function_ invoke__">Some</span>(my_string);</span><br><span class="line"><span class="keyword">match</span> some_string &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(<span class="keyword">ref</span> <span class="keyword">mut</span> s1) =&gt; &#123;</span><br><span class="line">        s1.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot; world&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;the value is &#123;&#125;&quot;</span>, s1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;nothing here&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;some_string is &#123;:?&#125;&quot;</span>, some_string); <span class="comment">//Some(&quot;hello world&quot;)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>The ability to mutate the inner value of a complex type (like Option or Vec) through a mutable reference stems from Rust’s general borrowing rules.</p>
</blockquote>
</li>
</ol>
<p>Based on this, even the my_string is immutable, since some_string is mutable, so the inner value of it is mutable as well.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/10/rust-0305-enum2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/10/rust-0305-enum2/" itemprop="url">Rust lesson 3.5 - Option and Result</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-10T21:50:41+08:00">
                2024-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Option-and-Result"><a href="#Option-and-Result" class="headerlink" title="Option and Result"></a>Option and Result</h1><h2 id="1-Option"><a href="#1-Option" class="headerlink" title="1. Option&lt;T&gt;"></a>1. <code>Option&lt;T&gt;</code></h2><p>There is no concept of ‘NULL’ in rust, and it is not a good practice anyway. <code>Option&lt;T&gt;</code> is came up to represent the two opposite status of the T: present(<code>Some(t)</code>) and absent (<code>None</code>).</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">some_number</span> = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">some_char</span> = <span class="title function_ invoke__">Some</span>(<span class="string">&#x27;e&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">absent_number</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Common-used-methods-of-Option"><a href="#Common-used-methods-of-Option" class="headerlink" title="Common used methods of Option"></a>Common used methods of Option</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unwrap()</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">some_number</span> = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">absent_value</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>; <span class="comment">// this will not panic now</span></span><br><span class="line"><span class="comment">// println!(</span></span><br><span class="line"><span class="comment">//     &quot;This will panic since value &#123;&#125; is absent&quot;,</span></span><br><span class="line"><span class="comment">//     absent_value.unwrap()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//expect()</span></span><br><span class="line"><span class="comment">// println!(</span></span><br><span class="line"><span class="comment">//     &quot;This will never be displayed &#123;&#125;&quot;,</span></span><br><span class="line"><span class="comment">//     absent_value.expect(&quot;panic more verbose&quot;)</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//is_some() and is_none() are opposite</span></span><br><span class="line"><span class="keyword">if</span> some_number.<span class="title function_ invoke__">is_some</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;some is &#123;&#125;&quot;</span>, some_number.<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//map() allows to process the value and return the result, the &#x27;result&#x27; and the &#x27;value&#x27; can be different types</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">simple_string</span>: <span class="type">Option</span>&lt;<span class="type">String</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>));</span><br><span class="line"><span class="keyword">let</span> <span class="variable">len</span>: <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; = simple_string.<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">len</span>()); <span class="comment">// len is 3</span></span><br><span class="line"><span class="built_in">assert_eq!</span>(len, <span class="title function_ invoke__">Some</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">absent_string</span>: <span class="type">Option</span>&lt;<span class="type">String</span>&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">len</span>: <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; = absent_string.<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">len</span>()); <span class="comment">// len is None</span></span><br><span class="line"><span class="built_in">assert_eq!</span>(len, <span class="literal">None</span>);</span><br></pre></td></tr></table></figure>

<h2 id="2-Result"><a href="#2-Result" class="headerlink" title="2. Result&lt;T&gt;"></a>2. <code>Result&lt;T&gt;</code></h2><p>Most errors aren’t serious enough to require the program to stop entirely. e.g., wrong password from a user should not stop the program.</p>
<p>Result enum is defined as having two variants, Ok and Err, as follows:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(T),</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>T: the type of the value that will be returned in a success case</li>
<li>E: the type of the error that will be returned in a failure case</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">greeting_file_result</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">greeting_file</span> = <span class="keyword">match</span> greeting_file_result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(file) =&gt; file,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(error) =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Problem opening the file: &#123;error:?&#125;&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, T is <code>File</code> and E is <code>String</code>.</p>
<p>In most cases, the <code>Result</code> is used as a return type to propagate the result to the function caller as follows:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Read&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_username_from_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">username_file_result</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">username_file</span> = <span class="keyword">match</span> username_file_result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(file) =&gt; file,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(e),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="as-a-shorthand-for-result-propagation"><a href="#as-a-shorthand-for-result-propagation" class="headerlink" title="? as a shorthand for result propagation"></a><code>? </code>as a shorthand for result propagation</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">read_username_from_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">username</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="comment">// if there is an error, the &#x27;?&#x27; would propagate it, continue execution otherwise.</span></span><br><span class="line">    File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>)?.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> username)?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(username)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Common-used-methods-of-Result"><a href="#Common-used-methods-of-Result" class="headerlink" title="Common used methods of Result"></a>Common used methods of Result</h3><p>As you can see they are quite similar to the Option’s methods.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">some_number</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">absent_value</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;This is error&quot;</span>);</span><br><span class="line"><span class="comment">//this will panic!</span></span><br><span class="line"><span class="comment">// println!(</span></span><br><span class="line"><span class="comment">//     &quot;This will panic since value &#123;&#125; is absent&quot;,</span></span><br><span class="line"><span class="comment">//     absent_value.unwrap()</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//expect()</span></span><br><span class="line"><span class="comment">// println!(</span></span><br><span class="line"><span class="comment">//     &quot;This will never be displayed &#123;&#125;&quot;,</span></span><br><span class="line"><span class="comment">//     absent_value.expect(&quot;panic more verbose&quot;)</span></span><br><span class="line"><span class="comment">// );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//is_some() and is_none() are opposite</span></span><br><span class="line"><span class="keyword">if</span> some_number.<span class="title function_ invoke__">is_ok</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;some is &#123;&#125;&quot;</span>, some_number.<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//map() allows to process the value and return the result, the &#x27;result&#x27; and the &#x27;value&#x27; can be different types</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">simple_string</span> = <span class="title function_ invoke__">Ok</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>));</span><br><span class="line"><span class="keyword">let</span> <span class="variable">len</span>: <span class="type">Result</span>&lt;<span class="type">usize</span>, &amp;<span class="type">str</span>&gt; = simple_string.<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">len</span>()); <span class="comment">// len is 3</span></span><br><span class="line"><span class="built_in">assert_eq!</span>(len, <span class="title function_ invoke__">Ok</span>(<span class="number">3</span> <span class="keyword">as</span> <span class="type">usize</span>));</span><br><span class="line"><span class="keyword">let</span> <span class="variable">absent_string</span>: <span class="type">Result</span>&lt;<span class="type">String</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;This is not a string&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">len</span> = absent_string.<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">len</span>());</span><br><span class="line"><span class="built_in">assert_eq!</span>(len, <span class="title function_ invoke__">Err</span>(<span class="string">&quot;This is not a string&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="3-Conversion-between-Option-and-Result"><a href="#3-Conversion-between-Option-and-Result" class="headerlink" title="3. Conversion between Option and Result"></a>3. Conversion between Option and Result</h2><h3 id="3-1-Option-Result"><a href="#3-1-Option-Result" class="headerlink" title="3.1 Option &#x3D;&gt; Result"></a>3.1 Option &#x3D;&gt; Result</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = opt.<span class="title function_ invoke__">ok_or</span>(<span class="string">&quot;Error: no value found&quot;</span>);<span class="comment">// res is Ok(42)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = opt.<span class="title function_ invoke__">ok_or</span>(<span class="string">&quot;Error: no value found&quot;</span>);<span class="comment">// res is Err(&quot;Error: no value found&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; = opt.<span class="title function_ invoke__">ok_or_else</span>(|| <span class="string">&quot;Generated error&quot;</span>.<span class="title function_ invoke__">to_string</span>());<span class="comment">// res is Err(&quot;Generated error&quot;)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-Result-Option"><a href="#3-2-Result-Option" class="headerlink" title="3.2 Result &#x3D;&gt; Option"></a>3.2 Result &#x3D;&gt; Option</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = res.<span class="title function_ invoke__">ok</span>();<span class="comment">// opt is Some(42)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;An error occurred&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = res.<span class="title function_ invoke__">ok</span>();<span class="comment">// opt is None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;An error occurred&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = res.<span class="title function_ invoke__">err</span>();<span class="comment">// opt is Some(&quot;An error occurred&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = res.<span class="title function_ invoke__">err</span>();<span class="comment">// opt is None</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/09/rust-0304-enum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/09/rust-0304-enum/" itemprop="url">Rust lesson 3.4 - Enum</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-09T20:28:32+08:00">
                2024-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Enum-101"><a href="#Enum-101" class="headerlink" title="Enum 101"></a>Enum 101</h1><h2 id="1-Defining-an-Enum"><a href="#1-Defining-an-Enum" class="headerlink" title="1. Defining an Enum"></a>1. Defining an Enum</h2><p>Enum allows you to define a set of values.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;, <span class="comment">// like a struct</span></span><br><span class="line">    <span class="title function_ invoke__">Write</span>(<span class="type">String</span>), <span class="comment">// string</span></span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(<span class="type">i32</span>, <span class="type">i32</span>, <span class="type">i32</span>), <span class="comment">// tuple</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Memory-layout-of-enums"><a href="#Memory-layout-of-enums" class="headerlink" title="Memory layout of enums"></a>Memory layout of enums</h2><ol>
<li>Discriminant(1 byte*):<ul>
<li>Rust stores a discriminant for each enum. This is an integer representing which variant is currently active.(Quit: 0, Move: 1…)</li>
<li>By default, Rust uses a u8 for the discriminant, as long as the enum has fewer than 256 variants.</li>
</ul>
</li>
<li>Variants<ul>
<li>this is the size of the variant’s value, e.g., <code>Move</code> has two i32 values, each of which is 4bytes, 8bytes in total.</li>
<li>Rust will align the enum to the size of its largest variant for efficient access.</li>
</ul>
</li>
</ol>
<p>In Rust, the size of an enum is typically determined by its largest variant. For example, consider an enum <code>Message</code> that includes variants such as <code>Write</code>, <code>Quit</code>, and <code>Move</code>.</p>
<ul>
<li>The <code>Write</code> variant might consist of a discriminant (usually 1 byte) and a <code>String</code> (which may vary in size, but let’s assume it uses 24 bytes for this explanation). Therefore, theoretically, the size of <code>Message</code> could be expected to be 25 bytes.</li>
</ul>
<p><strong>However</strong>, in practice, Rust uses a technique known as <strong>niche optimization</strong>. This means that if some of the variants are small or can share memory efficiently, the Rust compiler can optimize the size of the enum.</p>
<p>For instance, because the <code>Quit</code> and <code>Move</code> variants are small and can be represented with fewer bits, the actual size of the <code>Message</code> enum may be reduced to 24 bytes instead of the expected 25. This optimization allows Rust to pack these variants more efficiently in memory, thus saving space.</p>
<p>The size of a String</p>
<ul>
<li>a pointer:8 bytes on a 64-bit system</li>
<li>length: 8 bytes</li>
<li>capacity: 8 bytes</li>
</ul>
<h2 id="2-Option-and-Result"><a href="#2-Option-and-Result" class="headerlink" title="2. Option and Result"></a>2. Option and Result</h2><p>They enums defined by the standard library.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Option</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(T),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(T),</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-match-Control-Flow"><a href="#3-match-Control-Flow" class="headerlink" title="3. match Control Flow"></a>3. match Control Flow</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Coin</span> &#123;</span><br><span class="line">    Penny,</span><br><span class="line">    Nickel,</span><br><span class="line">    Dime,</span><br><span class="line">    Quarter,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">value_in_cents</span>(coin: Coin) <span class="punctuation">-&gt;</span> <span class="type">u8</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> coin &#123;</span><br><span class="line">        Coin::Penny =&gt; <span class="number">1</span>,</span><br><span class="line">        Coin::Nickel =&gt; <span class="number">5</span>,</span><br><span class="line">        Coin::Dime =&gt; <span class="number">10</span>,</span><br><span class="line">        Coin::Quarter =&gt; <span class="number">25</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are some important features of match:</p>
<ul>
<li>Catch-all pattern: the match arms need to cover all possible value, if we don’t want to list all: we can use a special pattern:<ul>
<li><code>other</code>: match other possible value</li>
<li><code>-</code>: match any value</li>
</ul>
</li>
<li><code>match</code> is also an expression and can be used to value assignment</li>
<li><code>match</code> can be used with non-enum types as well</li>
</ul>
<h2 id="4-if-let"><a href="#4-if-let" class="headerlink" title="4. if let"></a>4. <code>if let</code></h2><p>A concise version of <code>match</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//using match</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">match</span> coin &#123;</span><br><span class="line">    Coin::<span class="title function_ invoke__">Quarter</span>(state) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;State quarter from &#123;state:?&#125;!&quot;</span>),</span><br><span class="line">    _ =&gt; count += <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//using if let</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Coin</span>::<span class="title function_ invoke__">Quarter</span>(state) = coin &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;State quarter from &#123;state:?&#125;!&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/08/rust-0303-functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/08/rust-0303-functions/" itemprop="url">Rust lesson 3.3 - Functions</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-08T21:45:53+08:00">
                2024-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Functions-and-Methods"><a href="#Functions-and-Methods" class="headerlink" title="Functions and Methods"></a>Functions and Methods</h1><h2 id="1-Functions"><a href="#1-Functions" class="headerlink" title="1. Functions"></a>1. Functions</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_one</span>(x: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    x + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>fn</code> keyword</li>
<li>function name: plus_one</li>
<li><code>x</code> is the parameter, and type of it need be defined explicitly.</li>
<li><code>-&gt;</code> tells the return type is i32</li>
<li><code>x+1</code> is an expression, identical to <code>return x+1;</code></li>
</ul>
<h2 id="2-Methods"><a href="#2-Methods" class="headerlink" title="2. Methods"></a>2. Methods</h2><p>Methods are similar to functions, while theys are defined within the context of a struct (or an enum or a trait object), and their first parameter is always <strong>self</strong>, which represents the instance of the struct the method is being called on.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    width: <span class="type">u32</span>,</span><br><span class="line">    height: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">area</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.width * <span class="keyword">self</span>.height</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rect1</span> = Rectangle &#123;</span><br><span class="line">        width: <span class="number">30</span>,</span><br><span class="line">        height: <span class="number">50</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">&quot;The area of the rectangle is &#123;&#125; square pixels.&quot;</span>,</span><br><span class="line">        rect1.<span class="title function_ invoke__">area</span>()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Associated-Methods"><a href="#3-Associated-Methods" class="headerlink" title="3. Associated Methods"></a>3. Associated Methods</h2><p>They are functions associated with a type but not tied to any particular instance of that type.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Circle</span> &#123;</span><br><span class="line">    radius: <span class="type">f64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Circle</span> &#123;</span><br><span class="line">    <span class="comment">// Associated function (static-like method)</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Circle &#123; radius &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">pi</span>() <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">        <span class="number">3.1415</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method that takes `self` (instance method)</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">area</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">        <span class="number">3.1415</span> * <span class="keyword">self</span>.radius * <span class="keyword">self</span>.radius</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Calling the associated function</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">circle</span> = Circle::<span class="title function_ invoke__">new</span>(<span class="number">10.0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calling an instance method on the created instance</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The area of the circle is &#123;&#125;&quot;</span>, circle.<span class="title function_ invoke__">area</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The PI is &#123;&#125;&quot;</span>, Circle::<span class="title function_ invoke__">pi</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Trait"><a href="#4-Trait" class="headerlink" title="4. Trait"></a>4. Trait</h2><p>Traits can be used to define shared behavior in an abstract way. They are similar to the idea of ‘interfaces’ in other programming languages.</p>
<h3 id="4-1-Defining-a-trait"><a href="#4-1-Defining-a-trait" class="headerlink" title="4.1 Defining a trait"></a>4.1 Defining a trait</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>;</span><br><span class="line">    <span class="comment">//method with default implementation</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summary_type</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>&#123;</span><br><span class="line">        <span class="string">&quot;This is beliong to Summary type&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Implementing-a-trait-on-a-type"><a href="#4-2-Implementing-a-trait-on-a-type" class="headerlink" title="4.2 Implementing a trait on a type"></a>4.2 Implementing a trait on a type</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Tweet</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> username: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> content: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> reply: <span class="type">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> retweet: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Tweet</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Trait-Bound-Syntax"><a href="#4-3-Trait-Bound-Syntax" class="headerlink" title="4.3 Trait Bound Syntax"></a>4.3 Trait Bound Syntax</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T: Summary&gt;(item: &amp;T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// is same as:</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>(item: &amp;<span class="keyword">impl</span> <span class="title class_">Summary</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//to narrow down with multiple traits:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123;&#125;</span><br><span class="line"><span class="comment">//or:</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>(item: &amp;(<span class="keyword">impl</span> <span class="title class_">Summary</span>+ Display)) &#123;&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/08/rust-0302-ownership/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/08/rust-0302-ownership/" itemprop="url">Rust lesson 3.2 - Ownership and reference</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-08T21:04:40+08:00">
                2024-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Understanding-ownership"><a href="#Target-Understanding-ownership" class="headerlink" title="Target: Understanding ownership"></a>Target: Understanding ownership</h1><h2 id="1-Ownership"><a href="#1-Ownership" class="headerlink" title="1. Ownership"></a>1. Ownership</h2><h3 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3><ul>
<li><p>Each value in Rust has an owner.</p>
<p><code>let my_string = String::from(&quot;abc&quot;);</code> my_string is the owner of the string.</p>
</li>
<li><p>There can only be one owner at a time.</p>
<p><code>let str1 = my_string;</code> str1 is the owner, and my_string is no longer valid.</p>
</li>
<li><p>When the owner goes out of scope, the value will be dropped.</p>
<p><code>&#123;&#125;</code> defines the scope; the variable is no longer valid outside its scope.</p>
</li>
</ul>
<h2 id="2-Reference"><a href="#2-Reference" class="headerlink" title="2. Reference"></a>2. Reference</h2><p>Reference: accessing a variable without changing the ownership.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">abc_owner</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">abc_ref</span> = &amp;abc_owner; <span class="comment">// abc_ref is a reference. abc_owner is still the owner.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">efg_owner</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;efg&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">efg_ref</span> = &amp;<span class="keyword">mut</span> efg_owner; <span class="comment">// efg_ref is a mutable reference.</span></span><br><span class="line">efg_ref.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;hik&quot;</span>); <span class="comment">// efg_owner is now &quot;efghik&quot;.</span></span><br></pre></td></tr></table></figure>

<h3 id="Limitation-of-Reference"><a href="#Limitation-of-Reference" class="headerlink" title="Limitation of Reference"></a>Limitation of Reference</h3><p>The rule of reference is quite similar to read&#x2F;write lock:<br>A variable can have 1 ‘&amp;mut’ reference or multiple ‘&amp;’ reference.</p>
<h3 id="Scope-of-references"><a href="#Scope-of-references" class="headerlink" title="Scope of references"></a>Scope of references</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span>=<span class="type">String</span>::fr <span class="title function_ invoke__">om</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">r1</span>=&amp;s;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">r2</span>=&amp;s;</span><br><span class="line"><span class="built_in">println!</span>&#123;<span class="string">&quot;&#123;r1&#125; and &#123;r2&#125;&quot;</span>&#125;; <span class="comment">//r1 and r2 are no longer refered after this</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">r3</span> = &amp;<span class="keyword">mut</span> s; <span class="comment">//r3 is the only ref of s</span></span><br><span class="line"><span class="title function_ invoke__">println</span>(<span class="string">&quot;&#123;r3&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="3-Variables-in-memory"><a href="#3-Variables-in-memory" class="headerlink" title="3. Variables in memory"></a>3. Variables in memory</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span>=<span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span>=x;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;x = &#123;x&#125;, y = &#123;y&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s1</span>=<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s2</span>=s2</span><br><span class="line"><span class="comment">//println!(&quot;s1 = &#123;s1&#125;, s2 = &#123;s2&#125;&quot;); s1 is not valid here</span></span><br></pre></td></tr></table></figure>

<p>In this example we can see the primitive type (integer) behaves differently comparing to String. There are several reason:</p>
<ul>
<li>primitive variables are stored in the stack(cheap), while other types are stored in the heap(expansive).</li>
<li>Primitive variables implemented ‘copy’ trait, ‘y&#x3D;x’ actually creates a copy of ‘x’ and assigns it to ‘y’</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">str_literal</span>=<span class="string">&quot;abc&quot;</span>; <span class="comment">// &amp;str, stored distinctly from heap and stack</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s1</span>=<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;abc&quot;</span>); <span class="comment">//String</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s1_ref</span>=&amp;s1; <span class="comment">//&amp;String</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s2</span>=s1.<span class="title function_ invoke__">clone</span>() <span class="comment">//String, a separated instance in memory</span></span><br></pre></td></tr></table></figure>

<h2 id="4-mut"><a href="#4-mut" class="headerlink" title="4. mut"></a>4. <code>mut</code></h2><h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples:"></a>Examples:</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//a=6; This is Not allowed since a is immutable</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span>=<span class="number">10</span>;</span><br><span class="line">b=<span class="number">11</span>; <span class="comment">//This is fine</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">c</span>= &amp;<span class="keyword">mut</span> b;</span><br><span class="line"><span class="comment">//c=12; This is Not allowed, because c is immutable</span></span><br><span class="line"><span class="comment">//b=12; This is Not allowed because a value can only have one mutable reference which is &#x27;c&#x27;</span></span><br><span class="line">*c=<span class="number">12</span>; <span class="comment">//This is fine</span></span><br><span class="line"><span class="comment">//println!(&quot;value of b is &#123;&#125;&quot;, b);  Not allowed because b is borrowed</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">d</span> = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">e</span> = <span class="number">30</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;d is &#123;&#125;, e is &#123;&#125;&quot;</span>, d, e); <span class="comment">// d is 20, e is 30</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">f</span> = &amp;<span class="keyword">mut</span> d; <span class="comment">// f is a mutable reference to the mutable reference of d;</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;f is &#123;&#125;&quot;</span>, f); <span class="comment">//20</span></span><br><span class="line">*f = <span class="number">21</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;f is &#123;&#125;&quot;</span>, f); <span class="comment">//21</span></span><br><span class="line"><span class="comment">//println!(&quot;d is &#123;&#125;, f is &#123;&#125;&quot;, d, f); this is not allowed, f holds the exclusive reference of d, d is temporarily invalid</span></span><br><span class="line">f = &amp;<span class="keyword">mut</span> e;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;f is &#123;&#125;&quot;</span>, f); <span class="comment">//30</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;d is &#123;&#125;, f is &#123;&#125;&quot;</span>, d, f); <span class="comment">// This is fine because f released the reference to d.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Meaning-of-mut"><a href="#Meaning-of-mut" class="headerlink" title="Meaning of mut"></a>Meaning of <code>mut</code></h3><ul>
<li>The declared variable can be modified<ul>
<li><pre><code class="rust">  lex mut x=5;
  x=6;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- ```rust</span><br><span class="line">    let mut a = String::form(&quot;abc&quot;);</span><br><span class="line">    a = String::form(&quot;efg&quot;);</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
<li><code>&amp;mut</code> creats a mutable reference of a value. For example <code>let mut a = &amp;mut b;</code> meaning:<ul>
<li><code>a</code> would hold the exclusive access to b until <code>a</code> is out of scope.</li>
<li>The ownership of <code>b</code> will not changed, when <code>a</code> is no longer valid, the exclusive access will return to <code>b</code></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/08/rust-0301-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/08/rust-0301-types/" itemprop="url">Rust lesson 3.1 - Data Types</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-10-08T20:14:34+08:00">
                2024-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Getting-familiar-with-Data-types"><a href="#Target-Getting-familiar-with-Data-types" class="headerlink" title="Target: Getting familiar with Data types"></a>Target: Getting familiar with Data types</h1><h2 id="1-Scalar-Types"><a href="#1-Scalar-Types" class="headerlink" title="1. Scalar Types"></a>1. Scalar Types</h2><h3 id="1-1-Integer"><a href="#1-1-Integer" class="headerlink" title="1.1 Integer"></a>1.1 Integer</h3><h4 id="Types"><a href="#Types" class="headerlink" title="Types"></a>Types</h4><ul>
<li>i: signed</li>
<li>u: unsigned</li>
</ul>
<table>
<thead>
<tr>
<th>Length</th>
<th>Signed</th>
<th>Unsigned</th>
</tr>
</thead>
<tbody><tr>
<td><strong>8-bit</strong></td>
<td>i8</td>
<td>u8</td>
</tr>
<tr>
<td><strong>16-bit</strong></td>
<td>i16</td>
<td>u16</td>
</tr>
<tr>
<td><strong>32-bit</strong></td>
<td>i32</td>
<td>u32</td>
</tr>
<tr>
<td><strong>64-bit</strong></td>
<td>i64</td>
<td>u64</td>
</tr>
<tr>
<td><strong>128-bit</strong></td>
<td>i128</td>
<td>u128</td>
</tr>
<tr>
<td><strong>arch</strong></td>
<td>isize</td>
<td>usize</td>
</tr>
</tbody></table>
<h4 id="Integer-Literals"><a href="#Integer-Literals" class="headerlink" title="Integer Literals"></a>Integer Literals</h4><table>
<thead>
<tr>
<th>Number literals</th>
<th>Example</th>
</tr>
</thead>
<tbody><tr>
<td>Decimal</td>
<td>98_222</td>
</tr>
<tr>
<td>Hex</td>
<td>0xff</td>
</tr>
<tr>
<td>Octal</td>
<td>0o77</td>
</tr>
<tr>
<td>Binary</td>
<td>0b1111_0000</td>
</tr>
<tr>
<td>Byte (u8 only)</td>
<td>b’A’</td>
</tr>
</tbody></table>
<h3 id="1-2-Floating-Point"><a href="#1-2-Floating-Point" class="headerlink" title="1.2 Floating-Point"></a>1.2 Floating-Point</h3><p><code>f32, f64</code></p>
<p><strong>These will lose precision in the arithmetic, using integer instead</strong></p>
<h3 id="1-3-Boolean"><a href="#1-3-Boolean" class="headerlink" title="1.3 Boolean"></a>1.3 Boolean</h3><p>true&#x2F;false</p>
<h3 id="1-4-Character"><a href="#1-4-Character" class="headerlink" title="1.4 Character"></a>1.4 Character</h3><p>In rust, char can store any valid Unicaode(up to 4bytes).</p>
<p><code>&quot;a 你好&quot;</code></p>
<ul>
<li>‘a’: 1 byte (0x61)</li>
<li>‘你’: 3 bytes (0xe4 0xbd 0xa0)</li>
<li>‘好’: 3 bytes (0xe5 a5 bd)</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">text</span> = <span class="string">&quot;a你好&quot;</span>;</span><br><span class="line"><span class="comment">// Byte length of the string</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;Byte length: &#123;&#125;&quot;</span>, text.<span class="title function_ invoke__">len</span>()); <span class="comment">// 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Character length of the string</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;Character length: &#123;&#125;&quot;</span>, text.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">count</span>()); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Loop through every character</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> text.<span class="title function_ invoke__">chars</span>() &#123;</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">&quot;Character: &#123;&#125;&quot;</span>, c); <span class="comment">//a你好</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">ni</span> = text.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">nth</span>(<span class="number">1</span>); <span class="comment">//Some(你)</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">char_a</span>=text[<span class="number">0</span>];</span><br><span class="line"><span class="comment">//text[1]: this will NOT work, becease 你 is a slice from 1 to 3(text[1..4]), and spliting is not allowed</span></span><br></pre></td></tr></table></figure>

<h2 id="2-Compound-Types"><a href="#2-Compound-Types" class="headerlink" title="2. Compound Types"></a>2. Compound Types</h2><h3 id="2-1-Arrays"><a href="#2-1-Arrays" class="headerlink" title="2.1 Arrays"></a>2.1 Arrays</h3><ul>
<li>fixed length</li>
<li>same type</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]; <span class="comment">//</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">b</span>: [<span class="type">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="variable">c</span> = [<span class="number">3</span>; <span class="number">5</span>]; <span class="comment">//[3, 3, 3, 3, 3];</span></span><br><span class="line"><span class="comment">//to loop over the array</span></span><br><span class="line"><span class="keyword">for</span> <span class="title class_">n</span>:&amp;<span class="type">i32</span> <span class="keyword">in</span> a.iter&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> <span class="title class_">n</span>:&amp;<span class="type">i32</span>  <span class="keyword">in</span> &amp;a &#123;&#125;</span><br><span class="line"><span class="comment">//to access the value by its index</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;The first element in the array b is &#123;&#125;&quot;</span>, b[<span class="number">0</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-Structs"><a href="#2-2-Structs" class="headerlink" title="2.2 Structs"></a>2.2 Structs</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//regular</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    active: <span class="type">bool</span>,</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">    sign_in_count: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//tuple struct</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Color</span>(<span class="type">i32</span>, <span class="type">i32</span>, <span class="type">i32</span>);</span><br><span class="line"><span class="comment">//unit</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AlwaysEqual</span>;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/24/rust-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/09/24/rust-02/" itemprop="url">Rust lesson 2 - Rust basics</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-09-24T20:02:54+08:00">
                2024-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Getting-familiar-with-basics"><a href="#Target-Getting-familiar-with-basics" class="headerlink" title="Target: Getting familiar with basics"></a>Target: Getting familiar with basics</h1><h2 id="1-Variables-and-Mutability"><a href="#1-Variables-and-Mutability" class="headerlink" title="1. Variables and Mutability"></a>1. Variables and Mutability</h2><h3 id="1-1-Variables"><a href="#1-1-Variables" class="headerlink" title="1.1 Variables"></a>1.1 Variables</h3><p>To define a variable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let x=5;</span><br><span class="line">//x=6 would throw an error</span><br></pre></td></tr></table></figure>

<p>By default, the ‘x’ is immutabel, to make a variable mutable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let mut x=5;</span><br><span class="line">x=6;</span><br></pre></td></tr></table></figure>

<h4 id="Shadowing"><a href="#Shadowing" class="headerlink" title="Shadowing"></a>Shadowing</h4><p>Declaring a new variable with the same name as a previous variable, this is true for both mutable and immutable variables.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = x + <span class="number">1</span>; <span class="comment">//6</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = x * <span class="number">2</span>; <span class="comment">// 12</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;The value of x in the inner scope is: &#123;x&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of x is: &#123;x&#125;&quot;</span>); <span class="comment">//6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The shadowing variable can be defined as the different data type:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let spaces = &quot;   &quot;;</span><br><span class="line">let spaces = spaces.len();</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Constant"><a href="#1-2-Constant" class="headerlink" title="1.2 Constant"></a>1.2 Constant</h3><p>To define a constant:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const THREE_HOURS_IN_SECONDS: u32 = 60 * 60 * 3;</span><br></pre></td></tr></table></figure>

<p>Comparing to variables, the constant:</p>
<ul>
<li>is always immutable</li>
<li>annote the type explicitly</li>
<li>naming in uppercase fashion</li>
<li>value must be defined in the declaration</li>
<li>can not be shadowed</li>
</ul>
<h3 id="1-3-Static"><a href="#1-3-Static" class="headerlink" title="1.3 Static"></a>1.3 Static</h3><p>To define a static:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static THREE_HOURS_IN_SECONDS: u32 = 60 * 60 * 3;</span><br></pre></td></tr></table></figure>

<p>Comparing to constant, the static:</p>
<ul>
<li>can be mutable with ‘mut’ keyword, but this is NOT SAFE (surrounded in a ‘unsafe’ block).</li>
<li>in the runtime, the constant is the acutual value compiler would replace it in the compilation. while static is alway pointing to the address.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/23/rust-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/09/23/rust-01/" itemprop="url">Rust lesson 1 - Hello World!</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-09-23T20:12:52+08:00">
                2024-09-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Setting-up-Rust-development-environment"><a href="#Target-Setting-up-Rust-development-environment" class="headerlink" title="Target: Setting up Rust development environment"></a>Target: Setting up Rust development environment</h1><h2 id="1-Installation"><a href="#1-Installation" class="headerlink" title="1. Installation"></a>1. Installation</h2><p>Installing rustup in terminal:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 https://sh.rustup.rs -sSf | sh</span><br></pre></td></tr></table></figure>

<p>To check whether your installion successed:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rustc --version</span><br></pre></td></tr></table></figure>

<h2 id="2-Setting-up-IDE-VS-Code"><a href="#2-Setting-up-IDE-VS-Code" class="headerlink" title="2. Setting up IDE (VS Code)"></a>2. Setting up IDE (VS Code)</h2><p>If you are going to code rust with vs code, here are some usfer plugins:</p>
<ol>
<li>rust-analyzer</li>
<li>Even Better TOML</li>
<li>Dependi (a modern <code>cartes</code>)</li>
</ol>
<h2 id="3-Hello-World"><a href="#3-Hello-World" class="headerlink" title="3. Hello World"></a>3. Hello World</h2><p>To run our frist rust functio, we can simply create a ‘.rs’ file, e.g., ‘main.rs’:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then building it with command <code>rustc main.rs</code>, there would be a binary file ‘main’. And the file can be executed in your terminal or other command line tools.</p>
<h2 id="4-Cargo"><a href="#4-Cargo" class="headerlink" title="4. Cargo"></a>4. Cargo</h2><p>Cargo is Rust’s build system and package manager. It is a great tool helping developers building the codes and managing the dependices.</p>
<ol>
<li>Creating a Project with Cargo<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new hello_cargo</span><br></pre></td></tr></table></figure></li>
<li>Build the project<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo build</span><br></pre></td></tr></table></figure>
This command creates an executable file in target&#x2F;debug&#x2F;hello_cargo, similar to building with ‘rustc’.</li>
<li>Build and Run<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo run</span><br></pre></td></tr></table></figure></li>
<li>Just compile without producing an executable<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo check</span><br></pre></td></tr></table></figure></li>
<li>Building for Release<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo build --release</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="5-Dependencies-management-with-cargo"><a href="#5-Dependencies-management-with-cargo" class="headerlink" title="5. Dependencies management with cargo"></a>5. Dependencies management with cargo</h2><p>Dependencis of the project are listed in the ‘Cargo.toml’ file, for example:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello_cargo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rand</span>=<span class="string">&quot;0.8.5&quot;</span></span><br></pre></td></tr></table></figure>

<p>In this example, a ‘rand’ library is added.</p>
<h3 id="The-remote-repository-of-Cargo-dependencis-optional"><a href="#The-remote-repository-of-Cargo-dependencis-optional" class="headerlink" title="The remote repository of Cargo dependencis[optional]"></a>The remote repository of Cargo dependencis[optional]</h3><p>Sometimes, we want to change the remote repository for fatser downloading, the default source can be override by adding follow configuration in ‘$HOME&#x2F;.cargo&#x2F;config.toml’:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[source.crates-io]</span></span><br><span class="line"><span class="attr">replace-with</span> = <span class="string">&#x27;ustc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[source.ustc]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;git://mirrors.ustc.edu.cn/crates.io-index&quot;</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/16/Solidity-lesson4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/09/16/Solidity-lesson4/" itemprop="url">Solidity Lesson 4 - Upgradeable Smart Contracts</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-09-16T21:38:26+08:00">
                2024-09-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Understanding-Upgradeable-Smart-Contracts"><a href="#Target-Understanding-Upgradeable-Smart-Contracts" class="headerlink" title="Target: Understanding Upgradeable Smart Contracts"></a>Target: Understanding Upgradeable Smart Contracts</h1><h2 id="1-Key-concepts"><a href="#1-Key-concepts" class="headerlink" title="1. Key concepts"></a>1. Key concepts</h2><h3 id="1-1-Fallback-function"><a href="#1-1-Fallback-function" class="headerlink" title="1.1 Fallback function"></a>1.1 Fallback function</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fallback() external payable&#123;&#125;</span><br><span class="line">receieve() external payable&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fallback</strong> is a special function that is executed either when</p>
<ul>
<li>a function that does not exist is called or</li>
<li>Ether is sent directly to a contract but receive() does not exist or msg.data is not empty</li>
</ul>
<h3 id="1-2-Delegatecall-function"><a href="#1-2-Delegatecall-function" class="headerlink" title="1.2 Delegatecall function"></a>1.2 Delegatecall function</h3><p><strong>delegatecall</strong> is a low level function similar to <code>call</code>.<br>When contract A executes delegatecall to contract B, B’s code is executed with contract A’s storage, <code>msg.sender</code> and <code>msg.value</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.24;</span><br><span class="line"></span><br><span class="line">// NOTE: Deploy this contract first</span><br><span class="line">contract B &#123;</span><br><span class="line">    // NOTE: storage layout must be the same as contract A</span><br><span class="line">    uint256 public num;</span><br><span class="line">    address public sender;</span><br><span class="line">    uint256 public value;</span><br><span class="line"></span><br><span class="line">    function setVars(uint256 _num) public payable &#123;</span><br><span class="line">        num = _num;</span><br><span class="line">        sender = msg.sender;</span><br><span class="line">        value = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract A &#123;</span><br><span class="line">    uint256 public num;</span><br><span class="line">    address public sender;</span><br><span class="line">    uint256 public value;</span><br><span class="line"></span><br><span class="line">    function setVars(address _contract, uint256 _num) public payable &#123;</span><br><span class="line">        // A&#x27;s storage is set, B is not modified.</span><br><span class="line">        (bool success, bytes memory data) = _contract.delegatecall(</span><br><span class="line">            abi.encodeWithSignature(&quot;setVars(uint256)&quot;, _num)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-Storage"><a href="#1-3-Storage" class="headerlink" title="1.3 Storage"></a>1.3 Storage</h3><ul>
<li>Storage Slot Assignment: In Solidity, state variables are assigned to storage slots in the order they are declared:<ul>
<li>The first declared variable is stored in slot 0.</li>
<li>The second in slot 1, and so on.</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">contract MyImplementation &#123;</span><br><span class="line">    uint256 public value;  // Stored in slot 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Proxy Contract Storage: Even though the proxy contract doesn’t explicitly declare a value variable, its storage layout is still accessible to the implementation contract when delegatecall is used.<br>When delegatecall is invoked:</li>
<li>The value variable in MyImplementation refers to storage slot 0.</li>
<li>This slot 0 is located in the proxy contract’s storage.<br>Thus, when MyImplementation’s setValue function is called through the proxy:</li>
<li>The value in slot 0 of the proxy’s storage is updated.</li>
</ul>
<h2 id="2-The-idea-of-Upgradeable-contracts"><a href="#2-The-idea-of-Upgradeable-contracts" class="headerlink" title="2. The idea of Upgradeable contracts"></a>2. The idea of Upgradeable contracts</h2><p>Now, we have learnt the basics, the idea of upgradeable contracts is based on this:</p>
<ol>
<li>Undefined function calls to the proxy contract can be handled by the fallback function which will make a <code>delegatecall</code> to respective implementation contracts.</li>
<li><code>delegatecall</code> would only modify the proxy contract’s state variables, as long as those variables’ slot position and type are identical to implememtation contracts’, everything will works fine.</li>
</ol>
<h2 id="3-Patterns-of-Upgradeable-contracts"><a href="#3-Patterns-of-Upgradeable-contracts" class="headerlink" title="3. Patterns of Upgradeable contracts"></a>3. Patterns of Upgradeable contracts</h2><h3 id="3-1-Transparent-Proxy"><a href="#3-1-Transparent-Proxy" class="headerlink" title="3.1 Transparent Proxy"></a>3.1 Transparent Proxy</h3><p>Separates admin and user roles clearly, with the proxy itself handling upgrades and admin functions.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Implementation &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 _value) external &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract TransparentProxy &#123;</span><br><span class="line">    address private _implementation;</span><br><span class="line">    address private _admin;</span><br><span class="line"></span><br><span class="line">    constructor(address implementation_, address admin_) &#123;</span><br><span class="line">        _implementation = implementation_;</span><br><span class="line">        _admin = admin_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin() &#123;</span><br><span class="line">        require(msg.sender == _admin, &quot;Not admin&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgradeTo(address newImplementation) external onlyAdmin &#123;</span><br><span class="line">        _implementation = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _delegate(address implementation) internal &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            // Copy the call data.</span><br><span class="line">            calldatacopy(0, 0, calldatasize())</span><br><span class="line"></span><br><span class="line">            // Delegate the call to the implementation.</span><br><span class="line">            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)</span><br><span class="line"></span><br><span class="line">            // Copy the returned data.</span><br><span class="line">            returndatacopy(0, 0, returndatasize())</span><br><span class="line"></span><br><span class="line">            // Return the result of the call.</span><br><span class="line">            switch result</span><br><span class="line">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class="line">            default &#123; return(0, returndatasize()) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        if (msg.sender == _admin) &#123;</span><br><span class="line">            // If the caller is the admin, do nothing.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // Otherwise, delegate the call to the implementation.</span><br><span class="line">        _delegate(_implementation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        // Allow the contract to receive ETH.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract ProxyAdmin &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeProxyAdmin(TransparentProxy proxy, address newAdmin) external onlyOwner &#123;</span><br><span class="line">        proxy.upgradeTo(newAdmin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgrade(TransparentProxy proxy, address newImplementation) external onlyOwner &#123;</span><br><span class="line">        proxy.upgradeTo(newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, ProxyAdmin is used to control the proxy, and it is not necessary, especially for a single proxy scenario. The ProxyAdmin contract is an additional layer used to manage the proxy contract</p>
<h3 id="3-2-UUPS-Universal-Upgradeable-Proxy-Standard"><a href="#3-2-UUPS-Universal-Upgradeable-Proxy-Standard" class="headerlink" title="3.2 UUPS(Universal Upgradeable Proxy Standard)"></a>3.2 UUPS(Universal Upgradeable Proxy Standard)</h3><p>Places more responsibility on the implementation contract for managing upgrades, offering more flexibility but requiring careful management.</p>
<h3 id="3-3-Diamond-EIP-2535"><a href="#3-3-Diamond-EIP-2535" class="headerlink" title="3.3 Diamond(EIP-2535)"></a>3.3 Diamond(EIP-2535)</h3><p>Allowing for more complex upgradeable contracts, specifically those with multiple facets, each containing different functions. This pattern is highly flexible and allows contracts to scale without becoming monolithic.</p>
<hr>
<h3 id="Comparison-Table"><a href="#Comparison-Table" class="headerlink" title="Comparison Table:"></a>Comparison Table:</h3><table>
<thead>
<tr>
<th>Feature</th>
<th>Transparent Proxy</th>
<th>UUPS</th>
<th>Diamond (EIP-2535)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Upgrade Control</strong></td>
<td>Separate <code>ProxyAdmin</code> contract</td>
<td>Managed by implementation</td>
<td>Managed by facets</td>
</tr>
<tr>
<td><strong>Gas Efficiency</strong></td>
<td>More expensive (extra contract)</td>
<td>More gas-efficient</td>
<td>Potentially higher due to complexity</td>
</tr>
<tr>
<td><strong>Modularity</strong></td>
<td>Limited</td>
<td>Limited</td>
<td>Highly modular</td>
</tr>
<tr>
<td><strong>Admin Management</strong></td>
<td>Proxy admin vs user roles</td>
<td>Admin is in charge of upgrades</td>
<td>More complex admin control</td>
</tr>
<tr>
<td><strong>Upgradeability Granularity</strong></td>
<td>Entire implementation contract</td>
<td>Entire implementation contract</td>
<td>Upgrade individual facets</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Medium</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td><strong>Best Use Case</strong></td>
<td>DeFi, stable projects</td>
<td>Small apps or simple systems</td>
<td>Large modular platforms</td>
</tr>
</tbody></table>
<h3 id="Choosing-Between-Transparent-Proxy-UUPS-and-Diamond"><a href="#Choosing-Between-Transparent-Proxy-UUPS-and-Diamond" class="headerlink" title="Choosing Between Transparent Proxy, UUPS, and Diamond"></a>Choosing Between Transparent Proxy, UUPS, and Diamond</h3><ol>
<li><p><strong>Transparent Proxy</strong>:</p>
<ul>
<li>Best for established systems that need clear separation between users and admin.</li>
<li>Most widely used, considered more secure and tested, but a bit more complex.</li>
<li>Suitable for DeFi protocols or projects with high stakes and security needs.</li>
</ul>
</li>
<li><p><strong>UUPS</strong>:</p>
<ul>
<li>Ideal for lightweight contracts or simpler systems where ease of use and efficiency is more important.</li>
<li>You still have upgradeability without the overhead of managing a separate <code>ProxyAdmin</code> contract.</li>
</ul>
</li>
<li><p><strong>Diamond (EIP-2535)</strong>:</p>
<ul>
<li>Perfect for complex, modular systems that need to scale. If you’re building a platform that will continuously evolve with new features, Diamond’s facet-based architecture offers significant flexibility.</li>
<li>Adds complexity but provides long-term benefits in terms of modular upgrades.</li>
</ul>
</li>
</ol>
<p>Each upgrade pattern has its strengths, and the best choice depends on the complexity, gas efficiency, and upgrade requirements of your project.</p>
<h2 id="3-One-more-thing-about-Storage-slot"><a href="#3-One-more-thing-about-Storage-slot" class="headerlink" title="3. One more thing about Storage slot"></a>3. One more thing about Storage slot</h2><h3 id="Modular-storage"><a href="#Modular-storage" class="headerlink" title="Modular storage"></a>Modular storage</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.24;</span><br><span class="line"></span><br><span class="line">struct AppStorage &#123;</span><br><span class="line">    uint256 a;</span><br><span class="line">    uint8 b;</span><br><span class="line">    uint8 c;</span><br><span class="line">    uint8 d;</span><br><span class="line">    address contractA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">library Storage &#123;</span><br><span class="line">    bytes32 constant KEY = keccak256(&quot;storage-local&quot;);</span><br><span class="line"></span><br><span class="line">    function get() internal pure returns (AppStorage storage s) &#123;</span><br><span class="line">        bytes32 loc = KEY;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            s.slot := loc</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This allows the storage layout to be shared across different facets or functions, avoiding conflicts between different components.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/16/Solidity-lesson3.3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/09/16/Solidity-lesson3.3/" itemprop="url">Solidity Lesson 3.3 - Randomness</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-09-16T14:51:33+08:00">
                2024-09-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Target-Blockchain-Ethereum-Randomness-101"><a href="#Target-Blockchain-Ethereum-Randomness-101" class="headerlink" title="Target: Blockchain(Ethereum) Randomness 101"></a>Target: Blockchain(Ethereum) Randomness 101</h1><h2 id="1-Code-Example"><a href="#1-Code-Example" class="headerlink" title="1. Code Example"></a>1. Code Example</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.24;</span><br><span class="line"></span><br><span class="line">contract Hero &#123;</span><br><span class="line">    enum HeroType &#123;</span><br><span class="line">        Mege,</span><br><span class="line">        Healer,</span><br><span class="line">        Barbarian</span><br><span class="line">    &#125;</span><br><span class="line">    mapping(address =&gt; uint256[]) private addressToHeroType;</span><br><span class="line"></span><br><span class="line">    function getHeros() public view returns (uint256[] memory) &#123;</span><br><span class="line">        return addressToHeroType[msg.sender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function createHero(HeroType _type) public payable &#123;</span><br><span class="line">        require(msg.value &gt;= 0.5 ether, &quot;please send at least 0.5 eth&quot;);</span><br><span class="line"></span><br><span class="line">        uint256[] memory stats = new uint[](5);</span><br><span class="line">        stats[0] = 2;</span><br><span class="line">        stats[1] = 7;</span><br><span class="line">        stats[2] = 12;</span><br><span class="line">        stats[3] = 17;</span><br><span class="line">        stats[4] = 22;</span><br><span class="line"></span><br><span class="line">        uint256 len = 5;</span><br><span class="line">        uint h = uint256(_type);</span><br><span class="line"></span><br><span class="line">        do &#123;</span><br><span class="line">            uint256 pos = generateRandom() % len;</span><br><span class="line">            uint256 value = (generateRandom() % (13 + len)) + 1;</span><br><span class="line">            h |= value &lt;&lt; stats[pos];</span><br><span class="line">            len--;</span><br><span class="line">            stats[pos] = stats[len];</span><br><span class="line">        &#125; while (len &gt; 0);</span><br><span class="line"></span><br><span class="line">        addressToHeroType[msg.sender].push(h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function generateRandom() public view returns (uint256) &#123;</span><br><span class="line">        return</span><br><span class="line">            uint256(</span><br><span class="line">                keccak256(</span><br><span class="line">                    abi.encodePacked(</span><br><span class="line">                        block.prevrandao,</span><br><span class="line">                        block.timestamp,</span><br><span class="line">                        msg.sender</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-Why-the-generateRandom-is-insecure"><a href="#1-Why-the-generateRandom-is-insecure" class="headerlink" title="1. Why the generateRandom() is insecure"></a>1. Why the <code>generateRandom()</code> is insecure</h3><p><strong>Randomness via On-Chain Data (e.g., block.timestamp, block.prevrandao)</strong></p>
<pre><code>Using data like block.timestamp, block.prevrandao, and msg.sender is a common approach for generating “random” numbers in smart contracts. The idea is to take some data that varies from block to block and hash it (usually with keccak256), which gives a result that looks random but is predictable for someone who knows all the inputs.
</code></pre>
<h3 id="2-Other-issues"><a href="#2-Other-issues" class="headerlink" title="2. Other issues"></a>2. Other issues</h3><ul>
<li>shall we store the ‘stats’ other places to save gas?<ul>
<li><strong>in ‘storage’</strong>? NO! Reading from and writing to storage is much more expensive than working with memory. Storing a small, fixed-size array in storage may increase gas costs rather than reduce them.</li>
<li><strong>specifing it as ‘constant’?</strong> it is a good idea, however, only primitive time and fixed-sized byte array can be specified as ‘constant’</li>
<li><strong>specifing it as ‘immutable’?</strong> similar to ‘constant’, array can not specified as ‘immutable’.</li>
</ul>
</li>
<li><code>stats[pos] = stats[len];</code><br>This is very similar to the swap in the quicksort</li>
</ul>
<h2 id="2-Chainlink-VRF-2-5"><a href="#2-Chainlink-VRF-2-5" class="headerlink" title="2. Chainlink VRF 2.5"></a>2. Chainlink VRF 2.5</h2><h3 id="True-randomness-can-only-be-generated-off-chain"><a href="#True-randomness-can-only-be-generated-off-chain" class="headerlink" title="True randomness can only be generated off-chain"></a>True randomness can only be generated off-chain</h3><p><strong>Deterministic nature of blockchain</strong>: The Ethereum blockchain, like most blockchains, operates in a deterministic manner. This means that every operation performed on the blockchain must produce the same result for all nodes in the network. This determinism is essential to ensure consensus among all nodes, allowing them to agree on the state of the blockchain.</p>
<ul>
<li>Consensus: All nodes in the Ethereum network must be able to independently verify transactions and blocks to reach consensus.</li>
<li>Security: Determinism ensures that the outcome of a transaction is predictable and verifiable by anyone running an Ethereum node.</li>
</ul>
<h3 id="How-to-use-chainlink-VRF"><a href="#How-to-use-chainlink-VRF" class="headerlink" title="How to use chainlink VRF"></a>How to use chainlink VRF</h3><p><a target="_blank" rel="noopener" href="https://docs.chain.link/vrf/v2-5/subscription/get-a-random-number">Chainlink VRF2.5</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
